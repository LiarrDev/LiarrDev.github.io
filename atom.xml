<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://LiarrDev.github.io</id>
    <title>Liarr&apos;s Studio</title>
    <updated>2026-02-28T16:20:03.842Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://LiarrDev.github.io"/>
    <link rel="self" href="https://LiarrDev.github.io/atom.xml"/>
    <subtitle>æ¸©æ•…è€ŒçŸ¥æ–°</subtitle>
    <logo>https://LiarrDev.github.io/images/avatar.png</logo>
    <icon>https://LiarrDev.github.io/favicon.ico</icon>
    <rights>All rights reserved 2026, Liarr&apos;s Studio</rights>
    <entry>
        <title type="html"><![CDATA[ä½¿ç”¨ mp3agic è¯»å†™ MP3 çš„ ID3 æ ‡ç­¾]]></title>
        <id>https://LiarrDev.github.io/post/Reading-and-Manipulating-MP3-ID3-Tags-with-mp3agic/</id>
        <link href="https://LiarrDev.github.io/post/Reading-and-Manipulating-MP3-ID3-Tags-with-mp3agic/">
        </link>
        <updated>2026-02-26T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1>
<p>æ•°å¹´å‰ä¸ºäº†åº”å¯¹å„éŸ³ä¹å¹³å°çš„ç‰ˆæƒå‰²æ®ï¼Œæˆ‘å¼€å§‹å»ºç«‹è‡ªå·±çš„ç¦»çº¿éŸ³ä¹åº“ã€‚åªæ˜¯å½“å¹´çš„æˆ‘æ²¡æœ‰æ„è¯†åˆ°ï¼Œå®ƒä¼šåºå¤§åˆ°å°†è¿‘ 6 åƒé¦–æ­Œâ€”â€”è¿™è¿˜æ˜¯åœ¨æˆ‘è¿‘å‡ å¹´éƒ½æ²¡æœ‰ç»´æŠ¤çš„æƒ…å†µä¸‹ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://LiarrDev.github.io/post-images/1772293914084.png" alt="Music Lib" loading="lazy"></figure>
<p>ä¸ºäº†æ¸…æ™°ç®¡ç†ï¼Œåº“å»ºç«‹ä¹‹åˆæˆ‘å°±é‡‡ç”¨äº†ç»Ÿä¸€çš„æ–‡ä»¶å‘½åæ ¼å¼ï¼š<code>æ­Œæ‰‹ - æ­Œæ›².mp3</code>ã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://LiarrDev.github.io/post-images/1772293964378.png" alt="å‘½åè§„èŒƒ" loading="lazy"></figure>
<p>ç»ˆäºæœ‰ä¸€å¤©æˆ‘é¢å¯¹ç€è¿™ä¸ª 20 å‡  GB çš„æ–‡ä»¶å¤¹æ‰‹è¶³æ— æªæ—¶ï¼Œæˆ‘æ„è¯†åˆ°ï¼Œå®ƒè¿˜éœ€è¦è¿›ä¸€æ­¥æ•´ç†ã€‚</p>
<p>æˆ‘çš„æƒ³æ³•æ˜¯è¿™æ ·çš„ï¼Œä¸ºäº†æ–¹ä¾¿ç´¢å¼•ï¼Œæˆ‘åº”è¯¥ä¸ºæ­Œæ‰‹å»ºç«‹ä¸€ä¸ªç›®å½•ï¼Œç„¶åæ­Œæ‰‹ä¸‹å†å»ºç«‹ä¸“è¾‘å­ç›®å½•ï¼Œæœ€åæŠŠæ¯é¦–æ­Œæ›²å½’ç±»åˆ°å¯¹åº”çš„ä¸“è¾‘ä¸­å»ã€‚</p>
<pre><code>Music
  â”œâ”€â”€ Singer 1
  â”‚  â”œâ”€â”€ Album 1
  â”‚  â”‚  â”œâ”€â”€ Song 1
  â”‚  â”‚  â”œâ”€â”€ Song 2
  â”‚  â”‚  â””â”€â”€ Â·Â·Â·
  â”‚  â”œâ”€â”€ Album 2
  â”‚  â”‚  â”œâ”€â”€ Song 1
  â”‚  â”‚  â”œâ”€â”€ Song 2
  â”‚  â”‚  â””â”€â”€ Â·Â·Â·
  â”‚  â””â”€â”€ Â·Â·Â·
  â”œâ”€â”€ Singer 2
  â”‚  â”œâ”€â”€ Album 1
  â”‚  â”‚  â”œâ”€â”€ Song 1
  â”‚  â”‚  â”œâ”€â”€ Song 2
  â”‚  â”‚  â””â”€â”€ Â·Â·Â·
  â”‚  â”œâ”€â”€ Album 2
  â”‚  â”‚  â”œâ”€â”€ Song 1
  â”‚  â”‚  â”œâ”€â”€ Song 2
  â”‚  â”‚  â””â”€â”€ Â·Â·Â·
  â”‚  â””â”€â”€ Â·Â·Â·
  â””â”€â”€ Â·Â·Â·
</code></pre>
<p>æ­Œæ‰‹åå­—å’Œæ­Œæ›²åå­—éƒ½å¥½è¯´ï¼Œå¾—ç›Šäºæˆ‘è§„èŒƒçš„å‘½åï¼Œç›´æ¥è§£ææ–‡ä»¶åå°±å¯ä»¥æ‹¿åˆ°ï¼Œé‚£ä¹ˆä¸“è¾‘ååº”è¯¥å¦‚ä½•è·å–å‘¢ï¼Ÿ</p>
<p>ç‚¹å¼€ MP3 æ–‡ä»¶çš„å±æ€§ï¼Œå¯ä»¥çœ‹åˆ°å®ƒå†…éƒ¨å°±å­˜å‚¨äº†æ ‡é¢˜ã€æ­Œæ‰‹ã€ä¸“è¾‘ç­‰ä¿¡æ¯ï¼Œè¿™æ°å¥½èƒ½å¤Ÿæ»¡è¶³æˆ‘çš„éœ€è¦ã€‚</p>
<figure data-type="image" tabindex="3"><img src="https://LiarrDev.github.io/post-images/1772294056349.png" alt="MP3 Metadata" loading="lazy"></figure>
<p>é¦–å…ˆéœ€è¦äº†è§£è¿™äº›å…ƒæ•°æ®çš„å­˜å‚¨æ–¹å¼ã€‚MP3 æ–‡ä»¶çš„å…ƒæ•°æ®é€šå¸¸éµå¾ª ID3 æ ‡å‡†ï¼Œä¸»è¦åˆ†ä¸º ID3v1 å’Œ ID3v2 ä¸¤ç§ã€‚</p>
<p>ID3v1ï¼šä½äºæ–‡ä»¶å°¾éƒ¨ï¼Œé•¿åº¦ä¸º 128 å­—èŠ‚ï¼Œå¦‚æœ MP3 æ–‡ä»¶ä¸­æœ‰ APE æ ¼å¼ä¿¡æ¯ï¼Œåˆ™åœ¨ APE ä¿¡æ¯ä¹‹åã€‚ä¸æ”¯æŒå°é¢å’Œä¸€äº›ç‰¹æ®Šå­—ç¬¦ï¼Œå…¼å®¹æ€§è¾ƒå¥½ï¼Œä½†ä¿¡æ¯å®¹é‡æœ‰é™ã€‚</p>
<p>ID3v2ï¼šä½äºæ–‡ä»¶å¤´éƒ¨ï¼Œå¯ä»¥åŒ…å«å°é¢å’Œç‰¹æ®Šå­—ç¬¦ç­‰ï¼Œé•¿åº¦ä»»æ„ï¼Œæ˜¯ç›®å‰æœ€å¸¸ç”¨çš„æ ‡å‡†ã€‚å®ƒç”±ä¸€ä¸ªæ ‡ç­¾å¤´å’Œå¤šä¸ªå¸§ï¼ˆFrameï¼‰ç»„æˆã€‚</p>
<p>ID3v2 å½“å‰æœ€æ–°ç‰ˆæœ¬æ˜¯ ID3v2.4ï¼Œä½†ä¸€äº›è€è®¾å¤‡æˆ–è½¯ä»¶å¯èƒ½åªæ”¯æŒ ID3v2.3ã€‚</p>
<p>ID3v2.4 å¯¹ ID3v2.3 åšäº†ä¸€äº›æ”¹è¿›ï¼š</p>
<ul>
<li>å®¹é‡å’Œé™åˆ¶ï¼šID3v2.4 ç›¸æ¯” ID3v2.3 æœ‰æ›´å¥½çš„æ‰©å±•æ€§ï¼Œå¯ä»¥æ”¯æŒæ›´å¤§å®¹é‡çš„æ–‡ä»¶ã€‚</li>
<li>æ ‡ç­¾å¤§å°ï¼šID3v2.4 æ–°å¢äº† 16 ä½å’Œ 32 ä½çš„å¤§å°å­—æ®µï¼Œå¯ä»¥è¡¨ç¤ºæ›´å¤§çš„æ ‡ç­¾å°ºå¯¸ã€‚</li>
<li>æ–‡æœ¬ç¼–ç ï¼šID3v2.4 å¼ºåˆ¶ä½¿ç”¨ UTF-16 ç¼–ç ï¼Œè€Œ ID3v2.3 åˆ™é»˜è®¤ä½¿ç”¨ ISO-8859-1 ç¼–ç ã€‚</li>
<li>å¸§ç±»å‹ï¼šID3v2.4 åºŸå¼ƒäº†ä¸€äº›è¿‡æ—¶çš„å¸§ç±»å‹ï¼Œå¹¶å¼•å…¥äº†æ–°çš„å¸§ç±»å‹ï¼Œå¦‚ï¼šç”¨æˆ·è‡ªå®šä¹‰æ–‡æœ¬ä¿¡æ¯ç­‰ã€‚</li>
</ul>
<p>æ—¢ç„¶çŸ¥é“äº†å…ƒæ•°æ®å­˜å‚¨çš„ä½ç½®ï¼Œå¦‚ä½•è¯»å–å‘¢ï¼Ÿç›´æ¥è§£ææ–‡ä»¶çš„ <code>ByteArray</code> æ˜¯ä¸€ç§æ–¹æ¡ˆï¼Œä½†æ˜¯è¿™ç§æ–¹æ³•è¿‡äºç¡¬æ ¸ï¼Œä½¿ç”¨å°è£…è¿‡çš„ä¸‰æ–¹åº“æ˜¾ç„¶æ›´åŠ ç®€å•æ˜“ç”¨ã€‚</p>
<h1 id="ä½¿ç”¨-mp3agic">ä½¿ç”¨ mp3agic</h1>
<p>æˆ‘æ‰¾åˆ°äº†ä¸€ä¸ªåä¸º mp3agic çš„åº“ï¼Œå°½ç®¡è¯¥ä»“åº“ä¸Šä¸€æ¬¡æäº¤å·²ç»æ˜¯ 2022 å¹´ï¼Œå¹¶ä¸”åœ¨ 2024 å¹´å·²æ ‡æ³¨ä¸ºä¸å†ç§¯æç»´æŠ¤ï¼Œä½†æˆ‘å®é™…æµ‹è¯•ä¸‹æ¥ï¼Œä»èƒ½å¤Ÿæ»¡è¶³æˆ‘çš„éœ€æ±‚ã€‚</p>
<p>å…ˆæ¥çœ‹çœ‹ä½¿ç”¨æ–¹æ³•ã€‚</p>
<p>å¼•å…¥ä¾èµ–ï¼š</p>
<pre><code class="language-kotlin">dependencies {
    implementation(&quot;com.mpatric:mp3agic:0.9.1&quot;)
}
</code></pre>
<p>è¯»å– MP3 æ–‡ä»¶ï¼š</p>
<pre><code class="language-kotlin">fun open(file: File) {
    val mp3File = Mp3File(it)
    val length = mp3File.lengthInSeconds
    val bitrate = mp3File.bitrate
    val sampleRate = mp3File.sampleRate
    // ...
}
</code></pre>
<p>æ”¯æŒç›´æ¥ä½¿ç”¨è·¯å¾„æˆ–è€… <code>File</code> å®ä¾‹æ„å»º <code>Mp3File</code>ã€‚</p>
<p>ç§»é™¤ ID3 æˆ–è€…è‡ªå®šä¹‰ Tagï¼š</p>
<pre><code class="language-kotlin">fun deleteTag(mp3File: Mp3File, savePath: String) {
    if (mp3File.hasId3v1Tag()) {
        mp3File.removeId3v1Tag()
    }
    if (mp3File.hasId3v2Tag()) {
        mp3File.removeId3v2Tag()
    }
    if (mp3File.hasCustomTag()) {
        mp3File.removeCustomTag()
    }
    mp3File.save(savePath)
}
</code></pre>
<p>éœ€è¦ç•™æ„çš„æ˜¯ä¿®æ”¹åè°ƒç”¨ <code>save()</code> ä¿å­˜æ—¶ï¼Œä¸èƒ½ç›´æ¥è¦†ç›–åŸæ–‡ä»¶ï¼Œéœ€è¦æä¾›ä¸€ä¸ªæ–°çš„ä¿å­˜è·¯å¾„ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚</p>
<p>è·å– ID3v1 çš„å€¼ï¼š</p>
<pre><code class="language-kotlin">fun getId3v1(mp3File: Mp3File) {
    if (mp3File.hasId3v1Tag()) {
        val v1Tag = mp3File.id3v1Tag
        val track = v1Tag.track
        val artist = v1Tag.artist
        val album = v1Tag.album
        val title = v1Tag.title
        val year = v1Tag.year
        val genre = v1Tag.genre
        val genreDesc = v1Tag.genreDescription
        val comment = v1Tag.comment
        val version = v1Tag.version
        // ...
    }
}
</code></pre>
<p>è®¾ç½® ID3v1 çš„å€¼ï¼š</p>
<pre><code class="language-kotlin">fun setId3v1(mp3File: Mp3File, savePath: String) {
    val v1Tag = if (mp3File.hasId3v1Tag()) {
        mp3File.id3v1Tag
    } else {
        ID3v1Tag().also { mp3File.id3v1Tag = it }
    }
    v1Tag.track = &quot;5&quot;
    v1Tag.artist = &quot;An Artist&quot;
    v1Tag.title = &quot;The Title&quot;
    v1Tag.album = &quot;The Album&quot;
    v1Tag.year = &quot;2001&quot;
    v1Tag.genre = 12
    v1Tag.comment = &quot;Some comment&quot;
    // ...
    mp3File.save(savePath)
}
</code></pre>
<p>å…¶å®å°±æ˜¯ç®€å•çš„è°ƒç”¨ Getter å’Œ Setterã€‚</p>
<p>è·å– ID3v2 çš„å€¼ï¼š</p>
<pre><code class="language-kotlin">fun getId3v2(mp3File: Mp3File) {
    if (mp3File.hasId3v2Tag()) {
        val v2Tag = mp3File.id3v2Tag
        val track = v2Tag.track
        val artist = v2Tag.artist
        val album = v2Tag.album
        val title = v2Tag.title
        val year = v2Tag.year
        val genre = v2Tag.genre
        val genreDesc = v2Tag.genreDescription
        val comment = v2Tag.comment
        val version = v2Tag.version
        val lyrics = v2Tag.lyrics
        val composer = v2Tag.composer
        val publisher = v2Tag.publisher
        val origArtist = v2Tag.originalArtist
        val albumArtist = v2Tag.albumArtist
        val copyright = v2Tag.copyright
        val url = v2Tag.url
        val encoder = v2Tag.encoder
        val albumImage = v2Tag.albumImage
        if (albumImage != null) {
            val mime = v2Tag.albumImageMimeType
            // Write image to file - can determine appropriate file extension from the mime type
            val file = RandomAccessFile(&quot;album-artwork&quot;, &quot;rw&quot;)
            file.write(albumImage);
            file.close();
        }
        // ...
    }
}
</code></pre>
<p>å› ä¸º ID3v2 æ”¯æŒè®¾ç½®ä¸“è¾‘å°é¢ï¼Œæ‰€ä»¥ä¹Ÿå¯ä»¥è·å–åˆ°å°é¢å›¾ç‰‡ã€‚</p>
<p>è®¾ç½® ID3v2 çš„å€¼ï¼š</p>
<pre><code class="language-kotlin">fun setId3v2(mp3File: Mp3File, savePath: String) {
    val v2Tag = if (mp3File.hasId3v2Tag()) {
        mp3File.id3v2Tag
    } else {
        ID3v24Tag().also { mp3File.id3v2Tag = it }
    }
    v2Tag.track = &quot;5&quot;
    v2Tag.artist = &quot;An Artist&quot;
    v2Tag.title = &quot;The Title&quot;
    v2Tag.album = &quot;The Album&quot;
    v2Tag.year = &quot;2001&quot;
    v2Tag.genre = 12
    v2Tag.comment = &quot;Some comment&quot;
    v2Tag.lyrics = &quot;Some lyrics&quot;
    v2Tag.composer = &quot;The Composer&quot;
    v2Tag.publisher = &quot;A Publisher&quot;
    v2Tag.originalArtist = &quot;Another Artist&quot;
    v2Tag.albumArtist = &quot;An Artist&quot;
    v2Tag.copyright = &quot;Copyright&quot;
    v2Tag.url = &quot;http://foobar&quot;
    v2Tag.encoder = &quot;The Encoder&quot;
    v2Tag.setAlbumImage(byteArray, mime)
    // ...
    mp3File.save(&quot;MyMp3File.mp3&quot;)
}
</code></pre>
<p><code>Mp3File</code> æ”¯æŒåˆ›å»º ID3v2.2ã€ID3v2.3ã€ID3v2.4ï¼Œå¯ä»¥æŒ‰éœ€åˆ›å»ºã€‚</p>
<h1 id="ç¼–å†™æ•´ç†è„šæœ¬">ç¼–å†™æ•´ç†è„šæœ¬</h1>
<p>æœ‰äº†ä¸Šé¢çš„å·¥å…·ï¼Œä¸‹é¢å°±å¯ä»¥å†™ä¸€ä¸ªç¬¦åˆæˆ‘é¢„æœŸçš„è„šæœ¬äº†ï¼š</p>
<pre><code class="language-kotlin">object MusicScript {

    private const val SOURCE_DIR = &quot;/Users/Liarr/mp3-source&quot;
    private const val RESULT_DIR = &quot;/Users/Liarr/mp3-result&quot;
    private const val FIXED_DIR = &quot;/Users/Liarr/mp3-fixed&quot;

    fun group() {
        val dir = File(SOURCE_DIR)
        dir.listFiles()?.forEach {
            if (it.name.endsWith(&quot;.mp3&quot;)) { // é¿å…è¯»åˆ°æœ¬åœ° .DS_Store ç­‰é MP3 æ–‡ä»¶
                val regex = &quot;&quot;&quot;(.*) - (.*)\.mp3&quot;&quot;&quot;.toRegex()
                val matchResult = regex.find(it.name)
                val fileArtist = matchResult?.groupValues?.get(1)
                val fileTitle = matchResult?.groupValues?.get(2)

                if (fileArtist == null || fileTitle == null) {
                    return@forEach
                }
                val singerDir = File(RESULT_DIR, fileArtist)
                if (singerDir.exists().not()) {
                    singerDir.mkdirs()      // æ­Œæ‰‹æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»º
                }

                val mp3File = Mp3File(it)
                if (mp3File.hasId3v2Tag()) {
                    val v2Tag = mp3File.id3v2Tag

                    // ID3v2 Tag é‡Œé¢çš„æ•°æ®å’Œæ–‡ä»¶åè§£æå‡ºæ¥çš„ä¸ä¸€è‡´ï¼Œå¤§æ¦‚ç‡æ˜¯ä¹±ç äº†ï¼Œå°è¯•ä¿®æ­£
                    if (fileArtist != v2Tag.artist || fileTitle != v2Tag.title) {
                        val tagArtist = v2Tag.artist.correctCharset()
                        val tagTitle = v2Tag.title.correctCharset()
                        val tagAlbum = v2Tag.album.correctCharset()
                        if (tagArtist == fileArtist &amp;&amp; tagTitle == fileTitle) { // è½¬ç æ­£ç¡®ï¼Œé‡è®¾ ID3v2
                            v2Tag.artist = tagArtist
                            v2Tag.title = tagTitle
                            v2Tag.album = tagAlbum
                            // save æ–¹æ³•ä¸å…è®¸è¦†ç›–åŸæ–‡ä»¶ï¼Œå…ˆå­˜åˆ°å•ç‹¬æ–‡ä»¶å¤¹ï¼Œåé¢å†å¤„ç†
                            mp3File.save(FIXED_DIR + File.separator + it.name)
                            return@forEach
                        } else {    // è½¬ç åä¹Ÿä¸åŒ¹é…ï¼Œå°è¯•è¯»å– ID3v1
                            if (mp3File.hasId3v1Tag().not()) {
                                return@forEach
                            }
                            val v1Tag = mp3File.id3v1Tag
                            if (fileArtist != v1Tag.artist || fileTitle != v1Tag.title) {
                                return@forEach
                            }
                            // ID3v1 é‡Œé¢çš„æ•°æ®æ­£ç¡®ï¼Œé‡è®¾ ID3v2
                            v2Tag.artist = v1Tag.artist
                            v2Tag.title = v1Tag.title
                            v2Tag.album = v1Tag.album
                            // save æ–¹æ³•ä¸å…è®¸è¦†ç›–åŸæ–‡ä»¶ï¼Œå…ˆå­˜åˆ°å•ç‹¬æ–‡ä»¶å¤¹ï¼Œåé¢å†å¤„ç†
                            mp3File.save(FIXED_DIR + File.separator + it.name)
                            return@forEach
                        }
                    }

                    if (v2Tag.album.isBlank().not()) {
                        val albumDir = File(singerDir, v2Tag.album)
                        if (albumDir.exists().not()) {
                            albumDir.mkdirs()
                        }
                        val f = File(albumDir, it.name)
                        it.renameTo(f)
                    }
                }
            }
        }
    }

    private fun String.correctCharset() = String(this.toByteArray(Charsets.ISO_8859_1), Charset.forName(&quot;gbk&quot;))
}
</code></pre>
<p>æ€»ç»“ä¸€ä¸‹æˆ‘çš„å®ç°æ€è·¯ï¼š</p>
<ol>
<li>å®šä¹‰ä¸‰ä¸ªç›®å½•ï¼šæºæ–‡ä»¶å¤¹ã€è¾“å‡ºæ–‡ä»¶å¤¹ã€ä¿®å¤æ–‡ä»¶å¤¹ã€‚</li>
<li>éå†æºæ–‡ä»¶å¤¹ä¸‹æ‰€æœ‰ MP3 æ–‡ä»¶ï¼ˆé˜²æ­¢è¯»å–åˆ°æ¯”å¦‚ <code>.DS_Store</code> ç­‰é MP3 æ–‡ä»¶ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥<a href="https://liarrdev.github.io/post/Verify-File-Types-with-Media-Type-in-Java/">ä½¿ç”¨ Media Type æ ¡éªŒæ–‡ä»¶ç±»å‹</a>ï¼‰ã€‚</li>
<li>è§£ææ–‡ä»¶åå¾—åˆ°æ­Œæ‰‹å’Œæ­Œæ›²åï¼Œåœ¨è¾“å‡ºæ–‡ä»¶å¤¹ä¸­åˆ›å»ºæ­Œæ‰‹æ–‡ä»¶å¤¹ã€‚</li>
<li>è¯»å– MP3 çš„ ID3v2 æ ‡ç­¾ï¼Œæ£€æŸ¥æ ‡ç­¾ä¸­çš„æ­Œæ‰‹å’Œæ­Œæ›²æ˜¯å¦ä¸æ–‡ä»¶åä¸€è‡´ã€‚</li>
<li>å¦‚æœæ ‡ç­¾ä¸­çš„ä¿¡æ¯ä¸æ–‡ä»¶åä¸€è‡´ï¼Œä¸”ä¸“è¾‘åä¸ä¸ºç©ºï¼Œåˆ™å°†è¯¥æ–‡ä»¶ç§»åŠ¨åˆ°è¾“å‡ºæ–‡ä»¶å¤¹ä¸‹å¯¹åº”çš„ <code>æ­Œæ‰‹/ä¸“è¾‘</code> å­ç›®å½•ä¸­ã€‚</li>
<li>å¦‚æœæ ‡ç­¾ä¸­çš„ä¿¡æ¯ä¸æ–‡ä»¶åä¸ä¸€è‡´ï¼Œå°è¯•å°†å…¶è½¬æ¢ä¸º GBK ç¼–ç ï¼Œè‹¥è½¬æ¢ååŒ¹é…ï¼Œåˆ™ä¿®æ­£æ ‡ç­¾å¹¶ä¿å­˜åˆ°ä¿®å¤æ–‡ä»¶å¤¹ï¼Œä»ä¸åŒ¹é…åˆ™å°è¯•è¯»å– ID3v1 æ ‡ç­¾ï¼Œå¦‚æœ ID3v1 çš„ä¿¡æ¯ä¸æ–‡ä»¶åä¸€è‡´ï¼Œåˆ™å°†å…¶å†™å…¥åˆ° ID3v2ï¼Œå¹¶ä¿å­˜åˆ°ä¿®å¤æ–‡ä»¶å¤¹ä¸­ã€‚</li>
</ol>
<p>ä¸ºä»€ä¹ˆè¦åšæ–‡ä»¶åå’Œ ID3v2 çš„åŒ¹é…åˆ¤æ–­å‘¢ï¼Œå› ä¸ºè·‘è„šæœ¬çš„è¿‡ç¨‹ä¸­æˆ‘å‘ç°ï¼Œä¸€äº› MP3 æ–‡ä»¶è§£æå‡ºæ¥çš„ç»“æœæ˜¯ä¹±ç ï¼Œç³»ç»Ÿæ’­æ”¾å™¨ä¹Ÿä¸èƒ½æ­£å¸¸è¯†åˆ«ï¼š</p>
<figure data-type="image" tabindex="4"><img src="https://LiarrDev.github.io/post-images/1772294509391.png" alt="æ­Œæ›²ä¿¡æ¯ä¹±ç " loading="lazy"></figure>
<p>è¿™ç§æƒ…å†µä¸‹å¤§æ¦‚ç‡å°±æ˜¯ä¸Šæ–‡ä¸­æåˆ°çš„ ID3v2.3 é»˜è®¤ä½¿ç”¨ ISO-8859-1 ç¼–ç å¯¼è‡´çš„ï¼Œæ‰€ä»¥ä¼šå‡ºç°è·Ÿæ–‡ä»¶åè·Ÿ ID3v2 ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œå°è¯•å°†å…¶è½¬æ¢ä¸º GBK ç¼–ç ã€‚</p>
<p>æ‰§è¡Œè„šæœ¬åï¼Œè¾“å‡ºæ–‡ä»¶å¤¹ä¸­å°±å½’ç±»äº†æœ¬æ¥å°±ç¬¦åˆè¦æ±‚çš„ MP3 æ–‡ä»¶ï¼Œä¿®å¤æ–‡ä»¶å¤¹ä¸­åˆ™å¾—åˆ°äº†ç»è¿‡å¤„ç†çš„ MP3 æ–‡ä»¶ï¼Œæ­¤æ—¶å¯ä»¥æ‰‹åŠ¨æ£€æŸ¥ä¿®å¤æ–‡ä»¶å¤¹ä¸­çš„æ–‡ä»¶ï¼Œç¡®è®¤æ— è¯¯åæ›¿æ¢æºæ–‡ä»¶ï¼Œå†æ¬¡è¿è¡Œè„šæœ¬å³å¯ã€‚è¿™æ ·æ—¢ä¿è¯äº†è‡ªåŠ¨åŒ–æ•ˆç‡ï¼Œåˆç•™æœ‰äººå·¥å¤æ ¸çš„ç©ºé—´ã€‚</p>
<p>äºŒæ¬¡æ‰§è¡Œè„šæœ¬ä¹‹åå‰©ä¸‹çš„å°±æ˜¯æ— æ³•æ ¹æ®æˆ‘ä»¬å®šä¹‰çš„è§„åˆ™å¤„ç†çš„æ–‡ä»¶ï¼Œé‚£å°±éœ€è¦æ‰‹åŠ¨å¤„ç†äº†ã€‚</p>
<h1 id="é‡åˆ°çš„å°æ’æ›²">é‡åˆ°çš„å°æ’æ›²</h1>
<p>ç¬¬ä¸€æ¬¡è¿è¡Œè„šæœ¬æ—¶ï¼Œå‘ç°è®¸å¤šæ–‡ä»¶æ— æ³•ç§»åŠ¨ï¼Œè°ƒè¯•åˆ° <code>renameTo()</code> æ–¹æ³•è¿”å›äº† <code>false</code>ï¼Œæ’æŸ¥å‘ç°æ˜¯æƒé™é—®é¢˜ï¼Œè¿™äº›æ— æ³•è¢«ç§»åŠ¨çš„æ–‡ä»¶éƒ½è¢«è®¾ç½®äº† <code>uchg</code> æ ‡å¿—ï¼Œä¼°è®¡æ˜¯å¤šå¹´å‰ä¸ºäº†é˜²æ­¢æ„å¤–ä¿®æ”¹è€Œè®¾ç½®çš„åªè¯»å±æ€§ã€‚</p>
<p>æ‰§è¡Œå‘½ä»¤ï¼š</p>
<pre><code class="language-bash">âœ   ls -lO &quot;/Users/Liarr/mp3-source&quot;
# -rwxr-xr-x  1 hugecore  staff  uchg 4199728 Jan 24  2017 é™ˆå¥•è¿… - å¤©ä¸‹æ— åŒ.mp3
# ...
</code></pre>
<p>å¯ä»¥çœ‹åˆ°è¯¥ç›®å½•ä¸‹è¾“å‡ºçš„æ–‡ä»¶ä¿¡æ¯ä¸­éƒ½åŒ…å« <code>uchg</code> æ ‡å¿—ï¼ˆå³ user immutableï¼‰ï¼Œæœ‰è¿™ä¸ªæ ‡å¿—çš„æ–‡ä»¶æ— æ³•é€šè¿‡è„šæœ¬è¿›è¡Œä¿®æ”¹ã€åˆ é™¤ã€é‡å‘½åã€ç§»åŠ¨ç­‰æ“ä½œï¼Œæ‰€ä»¥éœ€è¦å…ˆæ‰§è¡Œå‘½ä»¤è§£é™¤ <code>uchg</code> æ ‡å¿—ï¼š</p>
<pre><code class="language-bash">âœ   sudo chflags -R nouchg &quot;/Users/Liarr/mp3-source&quot;
</code></pre>
<p>è¾“å…¥å¯†ç åå³å¯è§£é™¤ï¼Œåé¢è·‘è„šæœ¬å°±æ²¡æœ‰é—®é¢˜äº†ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ Jetpack Glance åŠ©åŠ› Compose AppWidget å¼€å‘]]></title>
        <id>https://LiarrDev.github.io/post/Empowers-Compose-AppWidget-with-Jetpack-Glance /</id>
        <link href="https://LiarrDev.github.io/post/Empowers-Compose-AppWidget-with-Jetpack-Glance /">
        </link>
        <updated>2026-02-01T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1>
<p>ä¹‹å‰ã€<a href="https://liarrdev.github.io/post/Building-Widgets-for-Android-Apps/">ä¸º Android åº”ç”¨æ„å»º Widget</a>ã€ä¸€æ–‡ä»‹ç»è¿‡åœ¨ Android ä¸­ Widget çš„å¼€å‘æµç¨‹ï¼Œæ–‡ä¸­çš„ç¤ºä¾‹æ˜¯åŸºäºã€Android Studioã€æä¾›çš„é»˜è®¤æ¨¡ç‰ˆï¼Œä¹Ÿå°±æ˜¯ <code>RemoteViews</code> æ¥æ„å»ºçš„ï¼Œå½“æ—¶çš„æ–‡ç« åå“ä¸é”™ï¼Œä¹Ÿå¼•å‘äº†ä¸å°‘è¯»è€…çš„è®¨è®ºï¼Œå…¶ä¸­æœ‰ä¸å°‘è¯»è€…æœŸå¾…åœ¨ Jetpack Compose ä¸­ä½¿ç”¨æ›´åŠ ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆï¼Œä»Šå¤©å®ƒæ¥äº†ã€‚</p>
<p>Google å¼€å‘äº†ä¸€ä¸ªæ„å»ºåœ¨ Jetpack Compose Runtime ä¹‹ä¸Šçš„æ¡†æ¶ï¼Œåä¸º Glanceï¼Œå¸®åŠ©ä½ ç”¨æ›´å°‘çš„ä»£ç å¿«é€Ÿæ„å»ºå“åº”å¼ Widgetã€‚</p>
<p>äº‹å…ˆå£°æ˜ï¼Œå¾—ç›Šäº Android è‰¯å¥½çš„å…¼å®¹æ–¹æ¡ˆï¼Œä¹‹å‰çš„ <code>RemoteViews</code> ä¾ç„¶å¯ç”¨ï¼Œä¸å¿…ä¸ºå…¶æ˜¯å¦éœ€è¦è¿ç§»æ„Ÿåˆ°ç„¦è™‘ã€‚</p>
<h1 id="å®è·µ">å®è·µ</h1>
<h2 id="åŸºæœ¬é…ç½®">åŸºæœ¬é…ç½®</h2>
<p>ã€Android Studioã€çš„é»˜è®¤åˆ›å»ºæ¨¡ç‰ˆ<a href="https://liarrdev.github.io/post/Building-Widgets-for-Android-Apps/">ä¹‹å‰çš„æ–‡ç« </a>ä¸­å·²ç»ä»‹ç»è¿‡äº†ï¼Œå®ƒä¸ Glance çš„é…ç½®å¤§ç›¸å¾„åº­ï¼Œæ‰€ä»¥æœ¬æ¬¡æˆ‘ä»¬å°†æ‰‹åŠ¨å®Œæˆé…ç½®ã€‚</p>
<p>é¦–å…ˆç¡®ä¿å½“å‰é¡¹ç›®çš„ Compose ç¯å¢ƒå·²ç»é…ç½®å®Œæˆï¼ŒCompose çš„é…ç½®æµç¨‹æœ¬æ–‡ä¸å†èµ˜è¿°ï¼Œè¯»è€…å¯ä»¥è‡ªè¡Œæœç´¢ã€‚</p>
<p>æ¥ä¸‹æ¥æ·»åŠ ä¾èµ–ï¼š</p>
<pre><code class="language-groovy">dependencies {
   // For AppWidgets support
   implementation &quot;androidx.glance:glance-appwidget:1.1.1&quot;
   // For interop APIs with Material 3
   implementation &quot;androidx.glance:glance-material3:1.1.1&quot;
   // For interop APIs with Material 2
   implementation &quot;androidx.glance:glance-material:1.1.1&quot;
}
</code></pre>
<p>æŒ‰éœ€æ·»åŠ å³å¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒGlance çš„ç‰ˆæœ¬å’Œå½“å‰ Compose çš„ç‰ˆæœ¬ä¹Ÿæ˜¯æœ‰å…³è”çš„ï¼Œå¦‚æœä¸å…¼å®¹å¯èƒ½ä¼šç¼–è¯‘å‡ºé”™ï¼Œä¿®æ”¹ç‰ˆæœ¬å·ä¸ºå¯¹åº”çš„ç‰ˆæœ¬å³å¯ã€‚</p>
<p>ç„¶åç¼–å†™ä¸€ä¸ªç»§æ‰¿è‡ª <code>GlanceAppWidget</code> çš„ç±»ï¼Œæˆ‘ä»¬çš„ Widget æ ·å¼å°†åœ¨è¿™é‡Œæ¸²æŸ“ï¼š</p>
<pre><code class="language-Kotlin">class MyAppWidget : GlanceAppWidget() {
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            GlanceTheme {
                MyContent()
            }
        }
    }

    @Composable
    private fun MyContent() {
        ...
    }
}
</code></pre>
<p>å®ç° <code>provideGlance()</code> æ–¹æ³•ï¼Œå¹¶åœ¨ <code>provideContent()</code> å†…åˆ›å»ºä½ çš„ Compose è§†å›¾ã€‚</p>
<p>æœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š</p>
<ul>
<li><code>provideGlance()</code> æ–¹æ³•è¿è¡Œåœ¨ä¸»çº¿ç¨‹ï¼Œæ‰€ä»¥è€—æ—¶æ“ä½œå»ºè®®ä½¿ç”¨åç¨‹å¤„ç†ã€‚</li>
<li>è™½ç„¶è¡¨é¢ä¸Šçœ‹å®ƒæ˜¯ä½¿ç”¨ Compose ç¼–å†™ UIï¼Œä½†å®é™…ä¸Š Glance å†…éƒ¨é‡æ–°æ„å»ºäº†ä¸€å¥—ä¸ Jetpack Compose ç±»ä¼¼çš„ç»„ä»¶åº“ï¼Œæ³¨æ„ä¸è¦å¯¼é”™åŒ…ã€‚</li>
</ul>
<p>Glance åªæ”¯æŒ <a href="https://developer.android.google.cn/reference/kotlin/androidx/glance/layout/package-summary#box"><code>Box</code></a>ã€<a href="https://developer.android.google.cn/reference/kotlin/androidx/glance/layout/package-summary#column"><code>Column</code></a>ã€<a href="https://developer.android.google.cn/reference/kotlin/androidx/glance/layout/package-summary#row"><code>Row</code></a>ã€<a href="https://developer.android.google.cn/reference/kotlin/androidx/glance/layout/package-summary#spacer"><code>Spacer</code></a>ã€<a href="https://developer.android.google.cn/reference/kotlin/androidx/glance/text/package-summary#text"><code>Text</code></a>ã€<a href="https://developer.android.google.cn/reference/kotlin/androidx/glance/package-summary#button"><code>Button</code></a>ã€<a href="https://developer.android.google.cn/reference/kotlin/androidx/glance/package-summary#image"><code>Image</code></a>ã€<a href="https://developer.android.google.cn/reference/kotlin/androidx/glance/appwidget/lazy/package-summary#lazycolumn"><code>LazyColumn</code></a>ã€<a href="https://developer.android.google.cn/reference/kotlin/androidx/glance/appwidget/components/package-summary#scaffold"><code>Scaffold</code></a> ç­‰ï¼Œå°½ç®¡éšç€ç‰ˆæœ¬æ›´æ–°è¿˜æ‹“å±•äº†ä¸€äº›å…¶ä»–çš„ç»„ä»¶ï¼Œä½†ä»ä¸ <code>RemoteViews</code> çš„é™åˆ¶å¤§åŒå°å¼‚ï¼Œäº‹å®ä¸Šï¼ŒGlance åªæ˜¯æä¾›äº† Compose-Style çš„å†™æ³•ï¼Œå®ƒä¾ç„¶ä¼šç¿»è¯‘æˆ <code>RemoteViews</code> å¯ç”¨çš„æ–¹æ¡ˆã€‚</p>
<p>å¦‚æœæœŸæœ› Glance èƒ½å¤Ÿçªç ´ç»„ä»¶é™åˆ¶çš„å¯ä»¥åŠé€€äº†ğŸ˜‚ã€‚</p>
<p>ç»§ç»­åˆ›å»ºä¸€ä¸ª <code>GlanceAppWidgetReceiver</code> ç”¨äºè·å–åˆšåˆšçš„ <code>GlanceAppWidget</code>ï¼š</p>
<pre><code class="language-kotlin">class MyAppWidgetReceiver : GlanceAppWidgetReceiver() {
    override val glanceAppWidget = MyAppWidget()
}
</code></pre>
<p>çœ‹åˆ°è¿™ä¸ªåå­—ç›¸ä¿¡ä½ å·²ç»å¯Ÿè§‰åˆ°äº†ï¼Œæˆ‘ä»¬ä¹‹å‰ä¼ ç»Ÿçš„æ„å»ºæ–¹å¼ä¹Ÿéœ€è¦æ³¨å†Œä¸€ä¸ªå¹¿æ’­ï¼Œæ‰’å¼€å®ƒçš„ç¥ç§˜é¢çº±ç…ä¸€çœ¼ï¼š</p>
<pre><code class="language-kotlin">abstract class GlanceAppWidgetReceiver : AppWidgetProvider() {
    ...
    abstract val glanceAppWidget: GlanceAppWidget
}
</code></pre>
<p>å¥½å®¶ä¼™ï¼Œè¿˜æ˜¯åŸºäºåŸæ¥çš„ <code>AppWidgetProvider</code> å°è£…çš„ã€‚</p>
<p>Glance æ³¨å†Œè¿˜éœ€è¦ä¸€ä¸ª <code>AppWidgetProviderInfo</code> å…ƒæ•°æ®ï¼Œè¿™ä¹Ÿæ˜¯è€æ¼”å‘˜äº†ï¼Œéœ€è¦ç•™æ„çš„æ˜¯ï¼ŒGlance æ²¡æœ‰é»˜è®¤çš„åˆå§‹å¸ƒå±€ï¼Œä½ å¯ä»¥ä½¿ç”¨å®ƒå†…éƒ¨å®šä¹‰çš„ï¼š</p>
<pre><code class="language-XML">&lt;appwidget-provider
    ...
    android:initialLayout=&quot;@layout/glance_default_loading_layout&quot; /&gt;
</code></pre>
<p>æœ€åå°±æ˜¯åœ¨ <code>AndroidManifest.xml</code> ä¸­æ³¨å†Œäº†ï¼ŒåŒä¹‹å‰ä¸€æ ·ï¼š</p>
<pre><code class="language-XML">&lt;manifest ...&gt;
    &lt;application ...&gt;
    ...
    &lt;receiver
        android:name=&quot;.widget.MyAppWidgetReceiver&quot;
        android:exported=&quot;false&quot;&gt;
        &lt;intent-filter&gt;
            &lt;action android:name=&quot;android.appwidget.action.APPWIDGET_UPDATE&quot; /&gt;
        &lt;/intent-filter&gt;
        &lt;meta-data
            android:name=&quot;android.appwidget.provider&quot;
            android:resource=&quot;@xml/my_app_widget_info&quot; /&gt;
        &lt;/receiver&gt;
    &lt;/application&gt;
&lt;/manifest&gt;
</code></pre>
<h2 id="æ›´æ–°-widget">æ›´æ–° Widget</h2>
<p>Glance å®˜æ–¹æ–‡æ¡£ä¸­å…³äºæ›´æ–° Widget çš„å†…å®¹æˆ‘è®¤ä¸ºæè¿°å¾—ä¸å¤Ÿè¯¦ç»†ï¼Œå®ƒåªå‘Šè¯‰ä½ è°ƒç”¨ <code>updateAll()</code> æ–¹æ³•å³å¯ï¼š</p>
<pre><code class="language-kotlin">object MyAppWidgetManager {
    fun updateAll(context: Context) {
        GlobalScope.launch {
            MyAppWidget().updateAll(context)
        }
    }
}
</code></pre>
<p>åˆæˆ–è€…è°ƒç”¨ <code>update()</code>ï¼š</p>
<pre><code class="language-kotlin">object MyAppWidgetManager {
    fun updateAll(context: Context) {
        GlobalScope.launch {
            val manager = GlanceAppWidgetManager(context)
            val widget = MyAppWidget()
            val glanceIds = manager.getGlanceIds(widget.javaClass)
            glanceIds.forEach { glanceId -&gt;
                widget.update(context, glanceId)
            }
        }
    }
}
</code></pre>
<p>ç”±äºè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½ä½¿ç”¨ <code>suspend</code> ä¿®é¥°ï¼Œæ‰€ä»¥å»ºè®®åœ¨éä¸»çº¿ç¨‹ä¸­è°ƒç”¨ã€‚</p>
<p>å¦‚æœä½¿ç”¨ä¼ ç»Ÿå¼€å‘ Widget çš„æ€ç»´ï¼Œè°ƒç”¨è¿™ä¸ªæ–¹æ³• Widget ä¾¿ä¼šæ‰§è¡Œåˆ·æ–°ï¼Œä½†æ˜¯å®é™…æ•ˆæœå´å¹¶ä¸èƒ½æ­£ç¡®æ‰§è¡Œï¼Œè¯·ä¸è¦è®¤ä¸ºåœ¨ä»»ä½•æ—¶å€™è°ƒç”¨è¿™ä¸ªæ–¹æ³•ä¼šè§¦å‘ <code>provideGlance()</code>ã€‚</p>
<p>å› ä¸º <code>GlanceAppWidget</code> çš„æ›´æ–°æ˜¯é€šè¿‡çŠ¶æ€ç®¡ç†çš„ï¼Œæ¯”å¦‚å®˜æ–¹çš„ä¾‹å­ï¼š</p>
<pre><code class="language-kotlin">class DestinationAppWidget : GlanceAppWidget() {
    ...
    @Composable
    fun MyContent() {
        val repository = remember { DestinationsRepository.getInstance() }
        val destinations by repository.destinations.collectAsState(State.Loading)

        when (destinations) {
            is State.Loading -&gt; {
                // show loading content
            }
            is State.Error -&gt; {
                // show widget error content
            }
            is State.Completed -&gt; {
                // show the list of destinations
            }
        }
    }
}
</code></pre>
<p>ä½†æˆ‘ä»¬é‡ç”Ÿå¼€å‘å´å¾ˆå°‘ä½¿ç”¨è¿™ç§çŠ¶æ€ï¼Œæ¯”å¦‚ç›´æ¥ä» <code>SharedPreferences</code> é‡Œé¢è¯»å–å€¼æ¥å±•ç¤ºï¼š</p>
<pre><code class="language-kotlin">class MyAppWidget : GlanceAppWidget() {
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            val foo = fetchFromPreferences()
            GlanceTheme {
                if (foo != null) {
                    MyContent(foo)
                } else {
                    DefaultContent()
                }
            }
        }
    }
    @Composable
    private fun MyContent(foo: Foo) {
        ...
    }
    @Composable
    private fun DefaultContent() {
        ...
    }
}
</code></pre>
<p>è¿™ç§å†™æ³•ä¼šå¯¼è‡´è°ƒç”¨ <code>update()</code> åˆ¤æ–­ä¸åˆ°çŠ¶æ€çš„å˜æ›´ï¼Œå¯¼è‡´ä¸ä¼šåˆ·æ–°ï¼Œå½“ç„¶é‡ç”Ÿå†™æ³•ä¹Ÿå¯ä»¥æ‰‹åŠ¨ç»™å®ƒæä¸€ä¸ªçŠ¶æ€ï¼š</p>
<pre><code class="language-kotlin">object MyAppWidgetManager {
    const val KEY_NOW = &quot;now&quot;
    fun updateAll(context: Context) {
        GlobalScope.launch {
            val glanceIds = GlanceAppWidgetManager(context).getGlanceIds(MyAppWidget::class.java)
            glanceIds.forEach { id -&gt;
                updateAppWidgetState(context, id) {
                    it[longPreferencesKey(KEY_NOW)] = System.currentTimeMillis()    // è®¾ç½®çŠ¶æ€
                }
                MyAppWidget().update(context, id)
            }
        }
    }
}
</code></pre>
<p>æ¯æ¬¡è°ƒç”¨ <code>update()</code> æ–¹æ³•å‰ï¼Œéƒ½æ›´æ–°ä¸€æ¬¡ Widget çš„çŠ¶æ€ï¼Œå³å¯åˆ·æ–°ï¼š</p>
<pre><code class="language-kotlin">class MyAppWidget : GlanceAppWidget() {
    override suspend fun provideGlance(context: Context, id: GlanceId) {
        provideContent {
            val now = currentState&lt;Preferences&gt;()[longPreferencesKey(MyAppWidgetManager.KEY_NOW)]   // è¯»å–çŠ¶æ€
            val foo = fetchFromPreferences()
            GlanceTheme {
                if (foo != null) {
                    MyContent(foo)
                } else {
                    DefaultContent()
                }
            }
        }
    }
    ...
}
</code></pre>
<h2 id="ä»-widget-ä¸­å¯åŠ¨åº”ç”¨">ä» Widget ä¸­å¯åŠ¨åº”ç”¨</h2>
<p>æˆ‘ä»¬çŸ¥é“ï¼ŒWidget è¿è¡Œåœ¨è¿œç¨‹è¿›ç¨‹ä¸­ï¼Œåœ¨ä¹‹å‰çš„ <code>RemoteViews</code> æ–¹æ¡ˆï¼Œæˆ‘ä»¬é€šè¿‡ <code>PendingIntents</code> æ¥å¯åŠ¨åº”ç”¨ï¼Œè€Œ Glance æä¾›äº†æ›´ä¼˜é›…çš„å®ç°æ–¹æ¡ˆã€‚</p>
<pre><code class="language-Kotlin">class MyAppWidget : GlanceAppWidget() {
    ...
    @Composable
    private fun MyContent() {
        Column {
            Button(text = &quot;Home&quot;, onClick = actionStartActivity&lt;MainActivity&gt;())
            Text(text = &quot;Settings&quot;, modifier = GlanceModifier.clickable(actionStartActivity&lt;SettingsActivity&gt;()))
        }
    }
}
</code></pre>
<p>Glance é€šè¿‡ <code>Action</code> æ¥ç®€åŒ–å¤„ç†ç”¨æˆ·äº’åŠ¨çš„æµç¨‹ï¼Œ<code>Action</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œåœ¨ä¸åŒçš„å¯åŠ¨åœºæ™¯ä¸­æœ‰ä¸åŒçš„å®ç°ã€‚</p>
<p>åœ¨éœ€è¦å¯åŠ¨ <code>Activity</code> æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨ <code>actionStartActivity()</code> æ–¹æ³•æŒ‡å®šç›®æ ‡ <code>Activity</code> å³å¯ï¼Œè¯¥æ–¹æ³•ä¼šè¿”å›ä¸€ä¸ª <code>StartActivityAction</code>ï¼Œ<code>StartActivityAction</code> ä¹Ÿæ˜¯ä¸€ä¸ªæ¥å£ï¼Œä¼ é€’ä¸åŒçš„å‚æ•°ç”± <code>StartActivityClassAction</code>ã€<code>StartActivityComponentAction</code>ã€<code>StartActivityIntentAction</code> ç­‰å…·ä½“å®ç°ã€‚</p>
<p><code>Button</code> å¯ä»¥é€šè¿‡ <code>onClick</code> æ¥æ”¶ <code>Action</code>ï¼Œå…¶ä»– <code>@Composable</code> ä¹Ÿå¯ä»¥é€šè¿‡ <code>GlanceModifier.clickable()</code> æ¥æ”¶ <code>Action</code>ã€‚</p>
<p>å¯åŠ¨çš„æ—¶å€™éœ€è¦ä¼ é€’å‚æ•°æ€ä¹ˆåŠï¼Œæˆ‘ä»¬çœ‹åˆ° <code>actionStartActivity()</code> æ–¹æ³•æœ‰ä¸ª <code>Bundle</code> å‚æ•°ï¼Œåƒä¸‡ä¸è¦è¢«è¿·æƒ‘äº†ï¼</p>
<pre><code class="language-kotlin">@ExperimentalGlanceApi
inline fun &lt;reified T : Activity&gt; actionStartActivity(
    parameters: ActionParameters = actionParametersOf(),
    activityOptions: Bundle? = null,
): Action = actionStartActivity(T::class.java, parameters, activityOptions)

@ExperimentalGlanceApi
fun &lt;T : Activity&gt; actionStartActivity(
    activity: Class&lt;T&gt;,
    parameters: ActionParameters = actionParametersOf(),
    activityOptions: Bundle? = null,
): Action = StartActivityClassAction(activity, parameters, activityOptions)
</code></pre>
<p>å¯åŠ¨ <code>Activity</code> æ‰€éœ€çš„å‚æ•°å¹¶ä¸æ˜¯åœ¨è¿™ä¸ª <code>Bundle</code> ä¸­ä¼ é€’çš„ï¼Œè€Œæ˜¯é€šè¿‡ <code>ActionParameters</code> ä¼ é€’çš„ã€‚å°½ç®¡ <code>ActionParameters</code> å’Œ <code>Bundle</code> ä¸€æ ·åº•å±‚å®ç°éƒ½æ˜¯ <code>Map</code>ï¼Œä½†ä¸åŒäº <code>Bundle</code> çš„é”®æ˜¯ <code>String</code> ç±»å‹ï¼Œ<code>ActionParameters</code> çš„é”®æ˜¯å†åšäº†ä¸€å±‚å°è£…çš„ <code>ActionParameters.Key</code>ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬éœ€è¦å†åšä¸€å±‚è½¬æ¢ï¼Œå¥½å¤„æ˜¯ä¸æ€•ä¼ é€’åˆ°é”™è¯¯çš„ç±»å‹ã€‚</p>
<pre><code class="language-kotlin">private val destinationKey = ActionParameters.Key&lt;String&gt;(NavigationActivity.KEY_DESTINATION)
class MyAppWidget : GlanceAppWidget() {
    ...
    @Composable
    private fun MyContent() {
        Button(
            text = &quot;Home&quot;, 
            onClick = actionStartActivity&lt;NavigationActivity&gt;(actionParametersOf(destinationKey to &quot;home&quot;))
        )
    }
}
</code></pre>
<p><code>ActionParameters.Key</code> ä¸­çš„æ³›å‹æŒ‡å®šä¸ºè¦ä¼ é€’çš„å€¼çš„ç±»å‹ï¼Œç„¶åä¼ å…¥æˆ‘ä»¬ <code>Activity</code> ä¸­å®šä¹‰çš„é”®åæ„é€ å®ä¾‹ã€‚é€šè¿‡ <code>actionParametersOf()</code> æ„é€  <code>ActionParameters</code> å¯¹è±¡ï¼Œå®ƒå†…éƒ¨å¯ä»¥å¡«å……å¤šç»„ <code>Pair</code> å¯¹åº”æˆ‘ä»¬è¦ä¼ é€’çš„å‚æ•°ã€‚å°†æ„å»ºå¥½çš„ <code>ActionParameters</code> å¯¹è±¡ä¼ é€’ç»™ <code>actionStartActivity()</code> æ–¹æ³•å³å¯ã€‚</p>
<p>ç›®æ ‡ <code>Activity</code> æ— éœ€åšå¤šä½™çš„ä¿®æ”¹ï¼Œè¿˜æ˜¯ä½¿ç”¨ <code>getIntent()</code> è¯»å–ï¼š</p>
<pre><code class="language-kotlin">class NavigationActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        val destination = intent.getStringExtra(KEY_DESTINATION)
        ...
    }
    companion object {
        const val KEY_DESTINATION = &quot;destination&quot;
    }
}
</code></pre>
<p>å…¶ä»–çš„æ“ä½œæ¯”å¦‚å¯åŠ¨ <code>Service</code> æˆ–è€…å‘é€å¹¿æ’­åŒæ ·æ˜¯é€šè¿‡ <code>Action</code> æ¥å®ç°ï¼Œè‡ªå®šä¹‰æ“ä½œä¹Ÿæ˜¯å¦‚æ­¤ï¼Œå¤§åŒå°å¼‚ï¼Œå‚ç…§æ–‡æ¡£å³å¯ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>
<h2 id="remoteviews-å…œåº•"><code>RemoteViews</code> å…œåº•</h2>
<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ XML å’Œ <code>RemoteViews</code> æ¥æä¾›è§†å›¾ã€‚æ¯”å¦‚å·²ç»åœ¨ä¸ä½¿ç”¨ Glance çš„æƒ…å†µä¸‹å®ç°äº†æŸé¡¹åŠŸèƒ½ï¼Œæˆ–è€…è¯¥åŠŸèƒ½åœ¨å½“å‰ Glance API å°šæœªæä¾›æˆ–æ— æ³•ä½¿ç”¨ã€‚å¯¹äºè¿™ç§æƒ…å†µ Glance æä¾›äº† <code>AndroidRemoteViews</code>ï¼Œè¿™æ˜¯ä¸€ä¸ªäº’æ“ä½œæ€§ APIã€‚ä¸éš¾çœ‹å‡ºï¼Œå®ƒæä¾›äº†ä¸ Compose ä¸­ <code>AndroidView</code> ç±»ä¼¼çš„åŠŸèƒ½ã€‚</p>
<p><code>AndroidRemoteViews</code> å…è®¸å°† <code>RemoteViews</code> ä¸å…¶ä»– <code>@Composable</code> æ­é…ä½¿ç”¨ï¼š</p>
<pre><code class="language-kotlin">class MyAppWidget : GlanceAppWidget() {
    ...
    @Composable
    private fun MyContent() {
        val packageName = LocalContext.current.packageName
        Column(modifier = GlanceModifier.fillMaxSize()) {
            Text(&quot;Isn't that cool?&quot;)
            AndroidRemoteViews(RemoteViews(packageName, R.layout.example_layout))
        }
    }
}
</code></pre>
<p>å°† <code>@Composable</code> æ”¾åœ¨ <code>AndroidRemoteViews</code> åŒæ ·å¯è¡Œï¼š</p>
<pre><code class="language-kotlin">class MyAppWidget : GlanceAppWidget() {
    ...
    @Composable
    private fun MyContent() {
        val packageName = LocalContext.current.packageName
        AndroidRemoteViews(
            remoteViews = RemoteViews(packageName, R.layout.my_container_view),
            containerViewId = R.id.example_view
        ) {
            Column(modifier = GlanceModifier.fillMaxSize()) {
                Text(&quot;My title&quot;)
                Text(&quot;Maybe a long content...&quot;)
            }
        }
    }
}
</code></pre>
<p>è¦æ³¨æ„çš„æ˜¯è¿™é‡Œéœ€è¦ä¼ é€’å¸ƒå±€å’Œå®¹å™¨ IDï¼Œæ„å‘³ç€è¿™ä¸ªå®¹å™¨å¿…é¡»æ˜¯ <code>ViewGroup</code>ï¼ŒåŒæ—¶è¯¥ <code>ViewGroup</code> å†…çš„æ‰€æœ‰å­ <code>View</code> éƒ½å°†è¢«ç§»é™¤ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯åœ¨æ­¤ <code>AndroidRemoteViews</code> ä¸­å¡«å……çš„å†…å®¹ã€‚ä¸è¦å¿˜è®°ï¼Œæä¾›çš„ <code>ViewGroup</code> å¿…é¡»å— <code>RemoteViews</code> æ”¯æŒã€‚</p>
<h1 id="å†™åœ¨æœ€å">å†™åœ¨æœ€å</h1>
<p>è¿™ç¯‡æ–‡ç« è™½ç„¶ä¸»è¦æ˜¯ä»‹ç» Glanceï¼Œä½†å®é™…ä¸Šæ˜¯å¯¹ã€<a href="https://liarrdev.github.io/post/Building-Widgets-for-Android-Apps/">ä¸º Android åº”ç”¨æ„å»º Widget</a>ã€ä¸€æ–‡çš„è¡¥å……ï¼Œå› ä¸º Glance ä»æ˜¯å¯¹ä¼ ç»Ÿå®ç° Widget çš„å°è£…ï¼Œæä¾›äº† Compose-Style çš„å†™æ³•ï¼Œå¹¶ä¸ä¼šè¶…è„±åŸæœ‰ Widget çš„é™åˆ¶ã€‚</p>
<p>Glance æ˜¯ä¸€ä¸ªå¾ˆæ–°çš„åº“ï¼Œç›®å‰è¿˜åœ¨å®éªŒé˜¶æ®µï¼Œä½†å·²åŸºæœ¬å¯ç”¨ï¼Œè€Œä¸”å®ƒå’Œ Compose çš„ç»“åˆéå¸¸ç´§å¯†ï¼Œä½¿ç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚å¦‚æœä½ æ­£åœ¨ä½¿ç”¨ Composeï¼Œé‚£ä¹ˆä¸å¦¨å°è¯•ä¸€ä¸‹ Glanceï¼Œç›¸ä¿¡ä½ ä¼šçˆ±ä¸Šå®ƒçš„ã€‚</p>
<p>ä¸è¿‡æˆ‘éœ€è¦åœ¨è¿™é‡Œæ‰“ä¸ªé¢„é˜²é’ˆï¼Œç»è¿‡æˆ‘ä»¬å®é™…åœ¨ä¼ä¸šé¡¹ç›®çš„éªŒè¯ï¼Œç›®å‰ Glance åœ¨ vivo è®¾å¤‡ä¸Šä¼šå‡ºç°ä¸€ä¸ª <code>IllegalStateException</code>ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://LiarrDev.github.io/post-images/1768730036222.png" alt="Firebase å´©æºƒè®°å½•" loading="lazy"></figure>
<p>å †æ ˆä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<pre><code>Fatal Exception: java.lang.IllegalStateException: Broadcast already finished
       at android.content.BroadcastReceiver$PendingResult.sendFinished(BroadcastReceiver.java:283)
       at android.content.BroadcastReceiver$PendingResult$1.run(BroadcastReceiver.java:256)
       at android.app.QueuedWork.processPendingWork(QueuedWork.java:265)
       at android.app.QueuedWork.-$$Nest$smprocessPendingWork()
       at android.app.QueuedWork$QueuedWorkHandler.handleMessage(QueuedWork.java:285)
       at android.os.Handler.dispatchMessage(Handler.java:106)
       at android.os.Looper.loopOnce(Looper.java:223)
       at android.os.Looper.loop(Looper.java:324)
       at android.os.HandlerThread.run(HandlerThread.java:67)
</code></pre>
<p>æˆ‘è¿½è¸ªåˆ°<a href="https://issuetracker.google.com/issues/257513022">åœ¨ Google IssueTracker ä¸Šä» 2022 å¹´å¼€å§‹å°±æœ‰è¿™ä¸ªé—®é¢˜</a>ï¼Œå¹¶ä¸”è‡³ä»Šä»æœªè¢«ä¿®å¤ï¼Œå°šä¸æ˜ç¡®åˆ°åº•æ˜¯ Glance çš„ Bug è¿˜æ˜¯ vivo OriginOS çš„é”…ã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://LiarrDev.github.io/post-images/1768730081261.png" alt="Crash with Glance" loading="lazy"></figure>
<h1 id="å‚è€ƒå†…å®¹">å‚è€ƒå†…å®¹</h1>
<ul>
<li><a href="https://developer.android.google.cn/develop/ui/compose/glance">Jetpack Glance | Jetpack Compose | Android Developers</a></li>
<li><a href="https://developer.android.google.cn/reference/kotlin/androidx/glance/layout/package-summary">androidx.glance.layout | Android Developers</a></li>
<li><a href="https://stackoverflow.com/questions/77088363/android-jetpack-glance-1-0-0-problems-updating-widget">Android Jetpack Glance 1.0.0 : problems updating widget - Stack Overflow</a></li>
<li><a href="https://medium.com/@Xiryl/unlock-the-secret-real-time-updates-for-glance-widgets-on-android-6907d0e06fa9">Unlock the Secret: Real-Time Updates for Glance Widgets on Android! | by Fabio Chiarani | Medium</a></li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[HarmonyOS ArkWeb æœ‰çº¿è°ƒè¯•]]></title>
        <id>https://LiarrDev.github.io/post/Debug-HarmonyOS-ArkWeb-via-HDC/</id>
        <link href="https://LiarrDev.github.io/post/Debug-HarmonyOS-ArkWeb-via-HDC/">
        </link>
        <updated>2025-12-28T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<p>æˆ‘ä»¬åœ¨è¿›è¡Œ Android å¼€å‘æ—¶ï¼Œå¦‚æœè¦è°ƒè¯• <code>WebView</code>ï¼Œé€šå¸¸åªéœ€è¦è¿æ¥ <code>adb</code>ï¼Œç„¶åå°±å¯ä»¥æ‰“å¼€ Chrome DevTools è¿›è¡Œè°ƒè¯•ã€‚</p>
<p>è€Œåœ¨ HarmonyOS ä¸Šï¼Œè™½ç„¶æœ‰ç±»ä¼¼ <code>adb</code> çš„å·¥å…·ï¼š<code>hdc</code>ï¼Œä½†æ˜¯è°ƒè¯• <code>ArkWeb</code> å´å¹¶ä¸æ–¹ä¾¿ã€‚</p>
<p>é¦–å…ˆéœ€è¦åœ¨éœ€è¦æ‰“å¼€è°ƒè¯•çš„é¡µé¢å¼€å¯å…è®¸è°ƒè¯•çš„å¼€å…³ï¼š</p>
<pre><code class="language-ts">@Entry(storage)
@Component
struct Index {
  ...
  aboutToAppear(): void {
    webview.WebviewController.setWebDebuggingAccess(BuildProfile.DEBUG)
  }
}
</code></pre>
<p>è¿™ä¸€æ­¥ä¸ Android æ— å¼‚ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>BuildProfile.DEBUG</code> å¾ˆæ–¹ä¾¿åœ°åˆ¤æ–­å½“å‰æ˜¯å¦ä¸º DEBUG åŒ…ï¼Œå°±ä¸éœ€è¦åœ¨ä¸Šçº¿æ—¶å†å°†å…¶é‡ç½®ä¸º <code>false</code> äº†ã€‚</p>
<p>ç„¶åé€šè¿‡ <code>hdc</code> è¿æ¥è®¾å¤‡ï¼Œå¹¶è¿›å…¥ Shellï¼š</p>
<pre><code class="language-bash">âœ   hdc shell
</code></pre>
<p>æ¥ç€æŸ¥æ‰¾ç›¸å…³è¿›ç¨‹ï¼š</p>
<pre><code class="language-bash">âœ   hdc shell
    âœ   cat /proc/net/unix | grep devtools
    # 0: 00000002 0 10000 1 1 49902021 @webview_devtools_remote_32259
</code></pre>
<p>æ‰§è¡Œå‘½ä»¤åä¼šè¾“å‡º <code>ArkWeb</code> æ‰€åœ¨ Domain Socket ç«¯å£ã€‚</p>
<p>é€€å‡º Shellï¼š</p>
<pre><code class="language-bash">âœ   hdc shell
    âœ   exit
</code></pre>
<p>å½“ç„¶æˆ‘ä»¬ä¹Ÿæœ‰å…¶ä»–æ–¹å¼èƒ½å¤ŸæŸ¥è¯¢åˆ° Domain Socketï¼Œæ¯”å¦‚é€šè¿‡åŒ…åï¼š</p>
<pre><code class="language-bash">âœ   hdc shell ps -ef | grep &quot;com.example.app&quot;
# 20020109       32259    652 0 12:48:30 ?     00:09:04 com.example.app
</code></pre>
<p>è¾“å‡ºçš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯æŸ¥è¯¢åˆ°çš„è¿›ç¨‹ IDã€‚</p>
<p>å°†æŸ¥è¯¢åˆ°çš„ Domain Socket è½¬å‘è‡³ç”µè„‘çš„ TCP <code>9222</code> ç«¯å£ï¼š</p>
<pre><code class="language-bash">âœ   hdc fport tcp:9222 localabstract:webview_devtools_remote_32259
# Forwardport result:OK
</code></pre>
<p>ä¸€èˆ¬è¾“å‡º OK å°±ä»£è¡¨è½¬å‘æˆåŠŸäº†ï¼Œä½ ä¹Ÿå¯ä»¥ç”¨ä¸‹é¢çš„å‘½ä»¤æ£€æŸ¥ä¸€ä¸‹</p>
<pre><code class="language-bash">âœ   hdc fport ls
# FMR0223A24001263    tcp:9222 localabstract:webview_devtools_remote_32259    [Forward]
</code></pre>
<p>æœ€åå°±å¯ä»¥åœ¨ç†Ÿæ‚‰çš„ Chrome DevTools ä¸Šè¿›è¡Œè°ƒè¯•äº†ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://LiarrDev.github.io/post-images/1766848500828.png" alt="DevTools" loading="lazy"></figure>
<p>ç”±äºæ­¥éª¤æ¯”è¾ƒç¹çï¼Œå®˜æ–¹ä¹Ÿæä¾›äº†ä¾¿æ·è„šæœ¬æ”¯æŒä¸€é”®è¿è¡Œï¼Œæœ‰éœ€è¦çš„æœ‹å‹å¯ä»¥å‰å¾€å®˜æ–¹æ–‡æ¡£è‡ªè¡Œä¸‹è½½ã€‚</p>
<p>ä» API version 20 å¼€å§‹ï¼Œå®˜æ–¹ä¹Ÿæ”¯æŒæŒ‡å®šç«¯å£å·æ— çº¿è°ƒè¯•ï¼Œç®€åŒ–è°ƒè¯•æµç¨‹ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Android åŸºäº WebKit çš„ Hybrid äº¤äº’æ–¹æ¡ˆ]]></title>
        <id>https://LiarrDev.github.io/post/Android-WebKit-Based-Hybrid-Interaction-Solution/</id>
        <link href="https://LiarrDev.github.io/post/Android-WebKit-Based-Hybrid-Interaction-Solution/">
        </link>
        <updated>2025-11-23T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<h1 id="èƒŒæ™¯">èƒŒæ™¯</h1>
<p>ä¹‹å‰ã€<a href="https://liarrdev.github.io/post/Interactin-with-JavaScript-in-Android-WebView">Android WebView å’Œ JavaScript äº¤äº’</a>ã€ä¸€æ–‡ä»‹ç»äº†æ™®é Hybrid å¼€å‘åœºæ™¯ä¸‹ Android å’Œ JavaScript çš„é€šä¿¡æ–¹å¼ï¼Œç›¸ä¿¡ç»å¤§å¤šæ•°é¡¹ç›®éƒ½æ˜¯ä½¿ç”¨è¿™ç§æ–¹å¼è¿›è¡Œäº¤äº’çš„ï¼Œä½†æ˜¯è¿™ç§æ–¹æ¡ˆå­˜åœ¨ä¸€äº›å®‰å…¨å’Œæ€§èƒ½é—®é¢˜ã€‚</p>
<p>è€Œ JetPack ç»™æˆ‘ä»¬å¸¦æ¥çš„ WebKit åº“æä¾›äº†ä¸€ç§æ–°çš„äº¤äº’æ–¹æ¡ˆã€‚</p>
<h1 id="å¯¼å…¥ä¾èµ–">å¯¼å…¥ä¾èµ–</h1>
<pre><code class="language-kts">dependencies {
    implementation(&quot;androidx.webkit:webkit:1.14.0&quot;)
}
</code></pre>
<h1 id="android-å‘-javascript-å‘é€æ¶ˆæ¯">Android å‘ JavaScript å‘é€æ¶ˆæ¯</h1>
<p>Android ç«¯ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-Kotlin">class MainActivity : AppCompatActivity() {
    ...
    private fun postMessage(msg: String) {
        if (WebViewFeature.isFeatureSupported(WebViewFeature.POST_WEB_MESSAGE)) {
            WebViewCompat.postWebMessage(
                binding.webview,
                WebMessageCompat(msg),
                HOST.toUri()
            )
        }
    }
    companion object {
        const val HOST = &quot;http://192.168.1.108:5500&quot;
    }
}
</code></pre>
<p>å…ˆåˆ¤æ–­ <code>WebView</code> æ˜¯å¦æ”¯æŒæ­¤æ–¹å¼å‘é€æ¶ˆæ¯ï¼Œç„¶åè°ƒç”¨ <code>WebViewCompat</code> çš„ <code>postWebMessage()</code> å‘é€ï¼Œè¯¥å‡½æ•°æ¥æ”¶ 3 ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯ <code>WebView</code>ï¼Œä¸ç”¨èµ˜è¿°ï¼Œç¬¬äºŒä¸ªæ˜¯æ¶ˆæ¯çš„åŒ…è£…ç±» <code>WebMessageCompat</code>ï¼Œæˆ‘ä»¬ä¼ ä¸€ä¸ª <code>String</code> ç±»å‹çš„æ¶ˆæ¯å³å¯ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ç”¨äºé™åˆ¶å“ªä¸ªç«™æºå¯ä»¥æ¥æ”¶æˆ‘ä»¬çš„æ¶ˆæ¯ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼ è‡ªæœ‰çš„åŸŸåï¼Œä¸é™åˆ¶çš„è¯ä¹Ÿå¯ä»¥ä½¿ç”¨é€šé…ç¬¦ <code>&quot;*&quot;</code> ä»£æ›¿ã€‚</p>
<p>åœ¨ H5 ç«¯ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•ç›‘å¬ï¼š</p>
<pre><code class="language-html">&lt;html&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
        ...
        window.addEventListener(&quot;message&quot;, function (event) {
            console.log(&quot;æ”¶åˆ°æ¶ˆæ¯:&quot;, event.data)
        }, false)
    &lt;/script&gt;
    ...
&lt;/html&gt;
</code></pre>
<p>é™¤äº†ç®€å•çš„ <code>String</code> ç±»å‹ï¼Œå®ƒè¿˜æ”¯æŒå­—èŠ‚æµï¼Œè¿™åœ¨æ–‡ä»¶ä¼ è¾“ä¸­ååˆ†æœ‰ç”¨ã€‚</p>
<p>ä¿®æ”¹ Android ç«¯ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-kotlin">class MainActivity : AppCompatActivity() {
    ...
    private fun postArrayBuffer(arrayBuffer: ByteArray) {
        if (WebViewFeature.isFeatureSupported(WebViewFeature.POST_WEB_MESSAGE)) {
            if (WebViewFeature.isFeatureSupported(WebViewFeature.WEB_MESSAGE_ARRAY_BUFFER)) {
                WebViewCompat.postWebMessage(
                    binding.webview,
                    WebMessageCompat(arrayBuffer),
                    HOST.toUri()
                )
            }
        }
    }
    companion object {
        const val HOST = &quot;http://192.168.1.108:5500&quot;
    }
}
</code></pre>
<p>éœ€è¦æ³¨æ„ï¼Œå‘é€å­—èŠ‚æµéœ€è¦åˆ¤æ–­æ˜¯å¦æ”¯æŒ <code>WebViewFeature.WEB_MESSAGE_ARRAY_BUFFER</code>ã€‚</p>
<p>å‡å¦‚ä¼ é€ä¸€ä¸ªå›¾ç‰‡ï¼ŒH5 ç«¯ç›‘å¬åå¯ä»¥è§£æï¼š</p>
<pre><code class="language-html">&lt;html&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
        ...
        window.addEventListener(&quot;message&quot;, function (event) {
            ...
            if (data instanceof ArrayBuffer) {
                const blob = new Blob([data], { type: &quot;image/png&quot; });
                const url = URL.createObjectURL(blob);
                const img = new Image();
                img.src = url;
                document.body.appendChild(img);
            }
        }, false)
    &lt;/script&gt;
    ...
&lt;/html&gt;
</code></pre>
<h1 id="javascript-å‘-android-ç«¯å‘é€æ¶ˆæ¯">JavaScript å‘ Android ç«¯å‘é€æ¶ˆæ¯</h1>
<p>Android ç«¯è®¾ç½®ç›‘å¬ï¼š</p>
<pre><code class="language-kotlin">class MainActivity : AppCompatActivity() {
    ...
    private fun addWebMessageListener() {
        if (WebViewFeature.isFeatureSupported(WebViewFeature.WEB_MESSAGE_LISTENER)) {
            WebViewCompat.addWebMessageListener(binding.webview, &quot;Android&quot;, setOf(HOST)) { view, message, sourceOrigin, isMainFrame, replyProxy -&gt;
                Log.e(&quot;moji&quot;, &quot;Android ç«¯æ”¶åˆ°æ¶ˆæ¯ï¼š${message.data}&quot;)
                // æ”¶åˆ°æ¶ˆæ¯åå¯ä»¥å›å¤
                replyProxy.postMessage(&quot;got the message @ ${System.currentTimeMillis()}&quot;)
            }
        }
    }
    companion object {
        const val HOST = &quot;http://192.168.1.108:5500&quot;
    }
}
</code></pre>
<p>é¦–å…ˆåŒæ ·éœ€è¦åˆ¤æ–­æ˜¯å¦æ”¯æŒç›‘å¬ï¼Œç„¶åè°ƒç”¨ <code>WebViewCompat</code> çš„ <code>addWebMessageListener()</code> æ–¹æ³•æ·»åŠ ç›‘å¬ï¼Œè¯¥å‡½æ•°æ¥æ”¶ 4 ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯ <code>WebView</code>ï¼Œä¸ç”¨èµ˜è¿°ï¼Œç¬¬äºŒä¸ªæ˜¯æ³¨å…¥ JS å¯¹è±¡çš„åç§°ï¼Œè¿™é‡Œå‘½åä¸º <code>Android</code>ï¼Œä¸‹é¢ä¼šç”¨åˆ°ï¼Œç¬¬ä¸‰ä¸ªå‚æ•°ç”¨æ¥æŒ‡å®šå“ªäº›ç«™æºä¼šæ³¨å…¥è¿™ä¸ªå¯¹è±¡ï¼Œç¬¬å››ä¸ªå‚æ•°å°±æ˜¯å›è°ƒæ¥å£ã€‚</p>
<p>æ”¶åˆ°æ¶ˆæ¯æˆ‘ä»¬å¯ä»¥è°ƒç”¨ <code>JavaScriptReplyProxy</code> å¯¹è±¡çš„ <code>postMessage()</code> ç»™ H5 ç«¯å‘ä¸ªå›å¤ã€‚</p>
<p>ç„¶å H5 ç«¯å°±å¯ä»¥å‘é€æ¶ˆæ¯äº†ï¼š</p>
<pre><code class="language-html">&lt;html&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
        ...
        function postMessage(message) {
            if (typeof Android !== &quot;undefined&quot;) {
                Android.postMessage(message);
                // æ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„å›å¤
                Android.onmessage = function (event) {
                    console.log(&quot;Android.onmessage received: &quot;, event);
                }
            }
        }
    &lt;/script&gt;
    ...
&lt;/html&gt;
</code></pre>
<p>å…¶ä¸­ <code>Android</code> å°±æ˜¯ä¸Šæ–¹æˆ‘ä»¬æ³¨å…¥å¯¹è±¡çš„åç§°ï¼Œè°ƒç”¨ <code>postMessage()</code> å‘é€æ¶ˆæ¯å³å¯ï¼Œå‡å¦‚ Android ç«¯æä¾›äº†å›å¤ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ <code>onmessage</code> æ¥ç›‘å¬ã€‚</p>
<p>åŒæ ·æ”¯æŒå­—èŠ‚æµï¼ŒAndroid ç«¯ä¿®æ”¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-kotlin">class MainActivity : AppCompatActivity() {
    ...
    private fun addWebMessageListener() {
        if (WebViewFeature.isFeatureSupported(WebViewFeature.WEB_MESSAGE_LISTENER)) {
            WebViewCompat.addWebMessageListener(binding.webview, &quot;Android&quot;, setOf(HOST)) { view, message, sourceOrigin, isMainFrame, replyProxy -&gt;
                if (message.type == WebMessageCompat.TYPE_ARRAY_BUFFER) {
                    val imageData = message.arrayBuffer
                    ...
                }
            }
        }
    }
    companion object {
        const val HOST = &quot;http://192.168.1.108:5500&quot;
    }
}
</code></pre>
<p>é€šè¿‡ <code>getType()</code> åˆ¤æ–­å¦‚æœæ˜¯å­—èŠ‚æµï¼Œå°±ç›´æ¥ä» <code>WebMessageCompat</code> ä¸­å–å‡ºæ•°æ®å³å¯ã€‚</p>
<p>H5 ç«¯ä½¿ç”¨åŒæ ·çš„æ–¹å¼å‘é€å­—èŠ‚æµå°±å¯ä»¥ï¼š</p>
<pre><code class="language-html">&lt;html&gt;
    &lt;script type=&quot;text/javascript&quot;&gt;
        ...
        function postArrayBuffer(buffer) {
            if (typeof Android !== &quot;undefined&quot;) {
                Android.postMessage(buffer);
            }
        }
    &lt;/script&gt;
    ...
&lt;/html&gt;
</code></pre>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<p>è¿™ç§æ–¹å¼å®‰å…¨ï¼Œä½†æ˜¯éœ€è¦åˆ¤æ–­æ˜¯å¦æ”¯æŒï¼ˆé—æ†¾çš„æ˜¯å›½å†…å¤§å¤šæ•°ç³»ç»Ÿ <code>WebView</code> å‡çº§è¿›åº¦æ‹–æ²“ï¼‰ï¼Œä¸€æ¥æ¯”è¾ƒç¹çï¼ŒäºŒæ¥åœ¨ä¸æ”¯æŒçš„è®¾å¤‡ä¸Šä»è¦å¯»æ±‚å…¶ä»–è§£å†³æ–¹æ¡ˆï¼Œå¢åŠ ç»´æŠ¤æˆæœ¬ã€‚</p>
<p>ä¸è¿‡ç›®å‰å…¶ä»–å¼€å‘å¹³å°æ¯”å¦‚ iOSã€HarmonyOSã€Flutter ç­‰äº¦é‡‡ç”¨ç±»ä¼¼çš„æ–¹æ¡ˆè¿›è¡Œé€šä¿¡ï¼Œä¸éš¾çœ‹å‡ºè¿™ç±»æ–¹æ¡ˆå°†ä¼šæˆä¸ºä¸»æµã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å¦‚ä½•è¿½è¸ª Android ä¾èµ–æ¥æº]]></title>
        <id>https://LiarrDev.github.io/post/How-to-Trace-Android-Dependency-Sources/</id>
        <link href="https://LiarrDev.github.io/post/How-to-Trace-Android-Dependency-Sources/">
        </link>
        <updated>2025-10-28T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<p>ç›¸ä¿¡åœ¨æ—¥å¸¸å¼€å‘ä¸­ä½ å·²ç»å‘ç°ï¼Œå½“æˆ‘ä»¬æ·»åŠ æŸä¸ªåº“çš„ä¾èµ–æ—¶ï¼Œå®ƒä¼šå¸®åŠ©æˆ‘ä»¬åŒæ­¥å®ƒæ‰€ä¾èµ–çš„åº“ï¼Œæ¯”å¦‚æˆ‘ä»¬å¸¸ç”¨çš„ç½‘ç»œè¯·æ±‚åº“ <a href="https://square.github.io/okhttp">OkHttp</a> å°±ä¾èµ–äº† <a href="https://square.github.io/okio">Okio</a>ï¼Œä½†æˆ‘ä»¬ä¾èµ– <a href="https://square.github.io/okhttp">OkHttp</a> æ—¶å¹¶ä¸éœ€è¦æŠŠ <a href="https://square.github.io/okio">Okio</a> çš„ä¾èµ–ä¹Ÿæ·»åŠ è¿›å»ï¼Œè¿™æ˜¯ç”± POM å£°æ˜çš„ã€‚</p>
<p>è¿™ç§æ–¹æ¡ˆèƒ½å¤Ÿå¸®åŠ©æˆ‘ä»¬å±è”½æ‰ä¸€äº›å¤šä½™çš„ä¿¡æ¯ï¼Œé™ä½ä¸Šæ‰‹é—¨æ§›ï¼Œä½†æœ‰æ—¶å€™å´ä¸åˆ©äºè¿½è¸ªã€‚</p>
<h1 id="è¿½è¸ª-aar-jar-ä¾èµ–">è¿½è¸ª AAR / JAR ä¾èµ–</h1>
<p>å¥½åœ¨ Android å®˜æ–¹å·²ç»å¸®æˆ‘ä»¬å‡†å¤‡å¥½ä¸€ä¸ª Gradle ä»»åŠ¡ç”¨äºåˆ†æé¡¹ç›®ä¸­çš„ä¾èµ–å…³ç³»ï¼Œæˆ‘ä»¬åªéœ€è¦ä¸€è¡Œå‘½ä»¤å°±å¯ä»¥æŸ¥è¯¢ã€‚</p>
<pre><code class="language-bash">âœ   ./gradlew app:dependencies
</code></pre>
<p>æ§åˆ¶å°ä¸­ä¼šè¾“å‡ºæ•´ä¸ªé¡¹ç›®çš„ä¾èµ–æ ‘ï¼š</p>
<pre><code class="language-bash">+--- androidx.appcompat:appcompat:1.7.1
|    +--- androidx.activity:activity:1.8.0 -&gt; 1.10.1
|    |    +--- androidx.annotation:annotation:1.8.1
|    |    |    \--- androidx.annotation:annotation-jvm:1.8.1
|    |    |         \--- org.jetbrains.kotlin:kotlin-stdlib:1.7.10 -&gt; 1.8.22
|    |    |              +--- org.jetbrains.kotlin:kotlin-stdlib-common:1.8.22
|    |    |              \--- org.jetbrains:annotations:13.0 -&gt; 23.0.0
|    |    +--- androidx.core:core-ktx:1.13.0
|    |    |    +--- androidx.annotation:annotation:1.1.0 -&gt; 1.8.1 (*)
|    |    |    +--- androidx.core:core:1.13.0
|    |    |    |    +--- androidx.annotation:annotation:1.6.0 -&gt; 1.8.1 (*)
|    |    |    |    +--- androidx.annotation:annotation-experimental:1.4.0
|    |    |    |    |    \--- org.jetbrains.kotlin:kotlin-stdlib:1.7.10 -&gt; 1.8.22 (*)
|    |    |    |    +--- androidx.lifecycle:lifecycle-runtime:2.6.2
|    |    |    |    |    +--- androidx.annotation:annotation:1.1.0 -&gt; 1.8.1 (*)
|    |    |    |    |    +--- androidx.arch.core:core-common:2.2.0
|    |    |    |    |    |    \--- androidx.annotation:annotation:1.1.0 -&gt; 1.8.1 (*)
|    |    |    |    |    +--- androidx.lifecycle:lifecycle-common:2.6.2
|    |    |    |    |    |    +--- androidx.annotation:annotation:1.1.0 -&gt; 1.8.1 (*)
|    |    |    |    |    |    +--- org.jetbrains.kotlin:kotlin-stdlib:1.8.10 -&gt; 1.8.22 (*)
|    |    |    |    |    |    +--- org.jetbrains.kotlinx:kotlinx-coroutines-android:1.6.4 -&gt; 1.7.3
|    |    |    |    |    |    |    +--- org.jetbrains.kotlinx:kotlinx-coroutines-core:1.7.3
|    |    |    |    |    |    |    |    \--- org.jetbrains.kotlinx:kotlinx-coroutines-core-jvm:1.7.3
|    |    |    |    |    |    |    |         +--- org.jetbrains:annotations:23.0.0
|    |    |    |    |    |    |    |         +--- org.jetbrains.kotlinx:kotlinx-coroutines-bom:1.7.3
|    |    |    |    |    |    |    |         |    +--- org.jetbrains.kotlinx:kotlinx-coroutines-android:1.7.3 (c)
|    |    |    |    |    |    |    |         |    +--- org.jetbrains.kotlinx:kotlinx-coroutines-core-jvm:1.7.3 (c)
|    |    |    |    |    |    |    |         |    \--- org.jetbrains.kotlinx:kotlinx-coroutines-core:1.7.3 (c)
|    |    |    |    |    |    |    |         +--- org.jetbrains.kotlin:kotlin-stdlib-common:1.8.20 -&gt; 1.8.22
|    |    |    |    |    |    |    |         \--- org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.8.20 -&gt; 1.8.22
|    |    |    |    |    |    |    |              +--- org.jetbrains.kotlin:kotlin-stdlib:1.8.22 (*)
|    |    |    |    |    |    |    |              \--- org.jetbrains.kotlin:kotlin-stdlib-jdk7:1.8.22
|    |    |    |    |    |    |    |                   \--- org.jetbrains.kotlin:kotlin-stdlib:1.8.22 (*)
|    |    |    |    |    |    |    +--- org.jetbrains.kotlinx:kotlinx-coroutines-bom:1.7.3 (*)
|    |    |    |    |    |    |    \--- org.jetbrains.kotlin:kotlin-stdlib-jdk8:1.8.20 -&gt; 1.8.22 (*)
|    |    |    |    |    |    +--- androidx.lifecycle:lifecycle-livedata-core:2.6.2 (c)
|    |    |    |    |    |    +--- androidx.lifecycle:lifecycle-runtime:2.6.2 (c)
|    |    |    |    |    |    +--- androidx.lifecycle:lifecycle-viewmodel:2.6.2 (c)
|    |    |    |    |    |    +--- androidx.lifecycle:lifecycle-viewmodel-savedstate:2.6.2 (c)
|    |    |    |    |    |    \--- androidx.lifecycle:lifecycle-livedata:2.6.2 (c)
|    |    |    |    |    +--- org.jetbrains.kotlin:kotlin-stdlib:1.8.10 -&gt; 1.8.22 (*)
|    |    |    |    |    +--- androidx.lifecycle:lifecycle-common:2.6.2 (c)
|    |    |    |    |    +--- androidx.lifecycle:lifecycle-livedata-core:2.6.2 (c)
|    |    |    |    |    +--- androidx.lifecycle:lifecycle-viewmodel:2.6.2 (c)
|    |    |    |    |    +--- androidx.lifecycle:lifecycle-viewmodel-savedstate:2.6.2 (c)
|    |    |    |    |    \--- androidx.lifecycle:lifecycle-livedata:2.6.2 (c)
|    |    |    |    +--- androidx.versionedparcelable:versionedparcelable:1.1.1
|    |    |    |    |    +--- androidx.annotation:annotation:1.1.0 -&gt; 1.8.1 (*)
|    |    |    |    |    \--- androidx.collection:collection:1.0.0 -&gt; 1.1.0
|    |    |    |    |         \--- androidx.annotation:annotation:1.1.0 -&gt; 1.8.1 (*)
|    |    |    |    \--- org.jetbrains.kotlin:kotlin-stdlib:1.8.22 (*)
|    |    |    \--- org.jetbrains.kotlin:kotlin-stdlib:1.8.22 (*)
|    |    +--- androidx.core:core-viewtree:1.0.0
|    |    |    +--- org.jetbrains.kotlin:kotlin-stdlib -&gt; 1.8.22 (*)
|    |    |    \--- org.jetbrains.kotlin:kotlin-stdlib:1.8.22 (c)
|    |    +--- androidx.lifecycle:lifecycle-common:2.6.1 -&gt; 2.6.2 (*)
|    |    +--- androidx.lifecycle:lifecycle-runtime:2.6.1 -&gt; 2.6.2 (*)
|    |    +--- androidx.lifecycle:lifecycle-viewmodel:2.6.1 -&gt; 2.6.2
|    |    |    +--- androidx.annotation:annotation:1.1.0 -&gt; 1.8.1 (*)
|    |    |    +--- org.jetbrains.kotlin:kotlin-stdlib:1.8.10 -&gt; 1.8.22 (*)
|    |    |    +--- androidx.lifecycle:lifecycle-common:2.6.2 (c)
|    |    |    +--- androidx.lifecycle:lifecycle-livedata-core:2.6.2 (c)
|    |    |    +--- androidx.lifecycle:lifecycle-runtime:2.6.2 (c)
|    |    |    +--- androidx.lifecycle:lifecycle-viewmodel-savedstate:2.6.2 (c)
|    |    |    \--- androidx.lifecycle:lifecycle-livedata:2.6.2 (c)
|    |    +--- androidx.lifecycle:lifecycle-viewmodel-savedstate:2.6.1 -&gt; 2.6.2
|    |    |    +--- androidx.annotation:annotation:1.0.0 -&gt; 1.8.1 (*)
|    |    |    +--- androidx.core:core-ktx:1.2.0 -&gt; 1.13.0 (*)
|    |    |    +--- androidx.lifecycle:lifecycle-livedata-core:2.6.2
|    |    |    |    +--- androidx.lifecycle:lifecycle-common:2.6.2 (*)
|    |    |    |    +--- org.jetbrains.kotlin:kotlin-stdlib:1.8.10 -&gt; 1.8.22 (*)
|    |    |    |    +--- androidx.lifecycle:lifecycle-common:2.6.2 (c)
|    |    |    |    +--- androidx.lifecycle:lifecycle-runtime:2.6.2 (c)
|    |    |    |    +--- androidx.lifecycle:lifecycle-viewmodel:2.6.2 (c)
|    |    |    |    +--- androidx.lifecycle:lifecycle-viewmodel-savedstate:2.6.2 (c)
|    |    |    |    \--- androidx.lifecycle:lifecycle-livedata:2.6.2 (c)
|    |    |    +--- androidx.lifecycle:lifecycle-viewmodel:2.6.2 (*)
|    |    |    +--- androidx.savedstate:savedstate:1.2.1
|    |    |    |    +--- androidx.annotation:annotation:1.1.0 -&gt; 1.8.1 (*)
|    |    |    |    \--- org.jetbrains.kotlin:kotlin-stdlib:1.8.10 -&gt; 1.8.22 (*)
|    |    |    +--- org.jetbrains.kotlin:kotlin-stdlib:1.8.10 -&gt; 1.8.22 (*)
|    |    |    +--- org.jetbrains.kotlinx:kotlinx-coroutines-android:1.6.4 -&gt; 1.7.3 (*)
|    |    |    +--- androidx.lifecycle:lifecycle-common:2.6.2 (c)
|    |    |    +--- androidx.lifecycle:lifecycle-livedata-core:2.6.2 (c)
|    |    |    +--- androidx.lifecycle:lifecycle-runtime:2.6.2 (c)
|    |    |    +--- androidx.lifecycle:lifecycle-viewmodel:2.6.2 (c)
|    |    |    \--- androidx.lifecycle:lifecycle-livedata:2.6.2 (c)
|    |    +--- androidx.savedstate:savedstate:1.2.1 (*)
|    |    +--- org.jetbrains.kotlin:kotlin-stdlib -&gt; 1.8.22 (*)
|    |    \--- org.jetbrains.kotlin:kotlin-stdlib:1.8.22 (c)
|    +--- androidx.annotation:annotation:1.3.0 -&gt; 1.8.1 (*)
|    +--- androidx.appcompat:appcompat-resources:1.7.1
|    |    +--- androidx.annotation:annotation:1.2.0 -&gt; 1.8.1 (*)
|    |    +--- androidx.core:core:1.6.0 -&gt; 1.13.0 (*)
|    |    +--- androidx.vectordrawable:vectordrawable:1.1.0
|    |    |    +--- androidx.annotation:annotation:1.1.0 -&gt; 1.8.1 (*)
|    |    |    +--- androidx.core:core:1.1.0 -&gt; 1.13.0 (*)
|    |    |    \--- androidx.collection:collection:1.1.0 (*)
|    |    +--- androidx.vectordrawable:vectordrawable-animated:1.1.0
|    |    |    +--- androidx.vectordrawable:vectordrawable:1.1.0 (*)
|    |    |    +--- androidx.interpolator:interpolator:1.0.0
|    |    |    |    \--- androidx.annotation:annotation:1.0.0 -&gt; 1.8.1 (*)
|    |    |    \--- androidx.collection:collection:1.1.0 (*)
|    |    \--- androidx.appcompat:appcompat:1.7.1 (c)
|    +--- androidx.core:core:1.13.0 (*)
|    +--- androidx.cursoradapter:cursoradapter:1.0.0
|    |    \--- androidx.annotation:annotation:1.0.0 -&gt; 1.8.1 (*)
|    +--- androidx.drawerlayout:drawerlayout:1.0.0 -&gt; 1.1.1
|    |    +--- androidx.annotation:annotation:1.1.0 -&gt; 1.8.1 (*)
|    |    +--- androidx.core:core:1.2.0 -&gt; 1.13.0 (*)
|    |    \--- androidx.customview:customview:1.1.0
|    |         +--- androidx.annotation:annotation:1.1.0 -&gt; 1.8.1 (*)
|    |         \--- androidx.core:core:1.3.0 -&gt; 1.13.0 (*)
|    +--- androidx.fragment:fragment:1.5.4
|    |    +--- androidx.activity:activity:1.5.1 -&gt; 1.10.1 (*)
|    |    +--- androidx.annotation:annotation:1.1.0 -&gt; 1.8.1 (*)
|    |    +--- androidx.annotation:annotation-experimental:1.0.0 -&gt; 1.4.0 (*)
|    |    +--- androidx.collection:collection:1.1.0 (*)
|    |    +--- androidx.core:core-ktx:1.2.0 -&gt; 1.13.0 (*)
|    |    +--- androidx.lifecycle:lifecycle-livedata-core:2.5.1 -&gt; 2.6.2 (*)
|    |    +--- androidx.lifecycle:lifecycle-viewmodel:2.5.1 -&gt; 2.6.2 (*)
|    |    +--- androidx.lifecycle:lifecycle-viewmodel-savedstate:2.5.1 -&gt; 2.6.2 (*)
|    |    +--- androidx.loader:loader:1.0.0
|    |    |    +--- androidx.annotation:annotation:1.0.0 -&gt; 1.8.1 (*)
|    |    |    +--- androidx.core:core:1.0.0 -&gt; 1.13.0 (*)
|    |    |    +--- androidx.lifecycle:lifecycle-livedata:2.0.0 -&gt; 2.6.2
|    |    |    |    +--- androidx.arch.core:core-runtime:2.1.0 -&gt; 2.2.0
|    |    |    |    |    +--- androidx.annotation:annotation:1.1.0 -&gt; 1.8.1 (*)
|    |    |    |    |    \--- androidx.arch.core:core-common:2.2.0 (*)
|    |    |    |    +--- androidx.lifecycle:lifecycle-livedata-core:2.6.2 (*)
|    |    |    |    +--- org.jetbrains.kotlin:kotlin-stdlib:1.8.10 -&gt; 1.8.22 (*)
|    |    |    |    +--- androidx.lifecycle:lifecycle-common:2.6.2 (c)
|    |    |    |    +--- androidx.lifecycle:lifecycle-livedata-core:2.6.2 (c)
|    |    |    |    +--- androidx.lifecycle:lifecycle-runtime:2.6.2 (c)
|    |    |    |    +--- androidx.lifecycle:lifecycle-viewmodel:2.6.2 (c)
|    |    |    |    \--- androidx.lifecycle:lifecycle-viewmodel-savedstate:2.6.2 (c)
|    |    |    \--- androidx.lifecycle:lifecycle-viewmodel:2.0.0 -&gt; 2.6.2 (*)
|    |    +--- androidx.savedstate:savedstate:1.2.0 -&gt; 1.2.1 (*)
|    |    +--- androidx.viewpager:viewpager:1.0.0
|    |    |    +--- androidx.annotation:annotation:1.0.0 -&gt; 1.8.1 (*)
|    |    |    +--- androidx.core:core:1.0.0 -&gt; 1.13.0 (*)
|    |    |    \--- androidx.customview:customview:1.0.0 -&gt; 1.1.0 (*)
|    |    \--- org.jetbrains.kotlin:kotlin-stdlib:1.6.21 -&gt; 1.8.22 (*)
|    +--- androidx.savedstate:savedstate:1.2.1 (*)
|    \--- androidx.appcompat:appcompat-resources:1.7.1 (c)
+--- com.google.android.material:material:1.12.0
|    +--- androidx.activity:activity:1.8.0 -&gt; 1.10.1 (*)
|    +--- androidx.annotation:annotation:1.2.0 -&gt; 1.8.1 (*)
|    +--- androidx.appcompat:appcompat:1.6.1 -&gt; 1.7.1 (*)
|    +--- androidx.cardview:cardview:1.0.0
|    |    \--- androidx.annotation:annotation:1.0.0 -&gt; 1.8.1 (*)
|    +--- androidx.coordinatorlayout:coordinatorlayout:1.1.0
|    |    +--- androidx.annotation:annotation:1.1.0 -&gt; 1.8.1 (*)
|    |    +--- androidx.core:core:1.1.0 -&gt; 1.13.0 (*)
|    |    +--- androidx.customview:customview:1.0.0 -&gt; 1.1.0 (*)
|    |    \--- androidx.collection:collection:1.0.0 -&gt; 1.1.0 (*)
|    +--- androidx.constraintlayout:constraintlayout:2.0.1 -&gt; 2.2.1
|    +--- androidx.core:core:1.6.0 -&gt; 1.13.0 (*)
|    +--- androidx.drawerlayout:drawerlayout:1.1.1 (*)
|    +--- androidx.dynamicanimation:dynamicanimation:1.0.0
|    |    +--- androidx.core:core:1.0.0 -&gt; 1.13.0 (*)
|    |    +--- androidx.collection:collection:1.0.0 -&gt; 1.1.0 (*)
|    |    \--- androidx.legacy:legacy-support-core-utils:1.0.0
|    |         +--- androidx.annotation:annotation:1.0.0 -&gt; 1.8.1 (*)
|    |         +--- androidx.core:core:1.0.0 -&gt; 1.13.0 (*)
|    |         +--- androidx.documentfile:documentfile:1.0.0
|    |         |    \--- androidx.annotation:annotation:1.0.0 -&gt; 1.8.1 (*)
|    |         +--- androidx.loader:loader:1.0.0 (*)
|    |         +--- androidx.localbroadcastmanager:localbroadcastmanager:1.0.0
|    |         |    \--- androidx.annotation:annotation:1.0.0 -&gt; 1.8.1 (*)
|    |         \--- androidx.print:print:1.0.0
|    |              \--- androidx.annotation:annotation:1.0.0 -&gt; 1.8.1 (*)
|    +--- androidx.annotation:annotation-experimental:1.0.0 -&gt; 1.4.0 (*)
|    +--- androidx.fragment:fragment:1.2.5 -&gt; 1.5.4 (*)
|    +--- androidx.lifecycle:lifecycle-runtime:2.0.0 -&gt; 2.6.2 (*)
|    +--- androidx.recyclerview:recyclerview:1.0.0 -&gt; 1.1.0
|    |    +--- androidx.annotation:annotation:1.1.0 -&gt; 1.8.1 (*)
|    |    +--- androidx.core:core:1.1.0 -&gt; 1.13.0 (*)
|    |    +--- androidx.customview:customview:1.0.0 -&gt; 1.1.0 (*)
|    |    \--- androidx.collection:collection:1.0.0 -&gt; 1.1.0 (*)
|    +--- androidx.resourceinspection:resourceinspection-annotation:1.0.1
|    +--- androidx.transition:transition:1.5.0
|    |    +--- androidx.annotation:annotation:1.2.0 -&gt; 1.8.1 (*)
|    |    \--- androidx.core:core:1.13.0 (*)
|    +--- androidx.vectordrawable:vectordrawable:1.1.0 (*)
|    \--- androidx.viewpager2:viewpager2:1.0.0
|         +--- androidx.annotation:annotation:1.1.0 -&gt; 1.8.1 (*)
|         +--- androidx.fragment:fragment:1.1.0 -&gt; 1.5.4 (*)
|         +--- androidx.recyclerview:recyclerview:1.1.0 (*)
|         +--- androidx.core:core:1.1.0 -&gt; 1.13.0 (*)
|         \--- androidx.collection:collection:1.1.0 (*)
+--- androidx.activity:activity:1.10.1 (*)
+--- androidx.constraintlayout:constraintlayout:2.2.1
</code></pre>
<h1 id="è¿½è¸ª-so-ä¾èµ–">è¿½è¸ª SO ä¾èµ–</h1>
<p>åœ¨æ·»åŠ çš„ AAR ä¾èµ–ä¸­è¿˜å¯èƒ½å­˜åœ¨ SO åº“ï¼Œè¿™è¿½è¸ªèµ·æ¥å°±ç›¸å¯¹éº»çƒ¦ä¸€äº›ï¼Œç›¸ä¿¡è¿‘æœŸé€‚é… Android 16KB Page Size çš„å°ä¼™ä¼´å¯èƒ½æ·±æœ‰ä½“ä¼šã€‚</p>
<p>æˆ‘ç›®å‰æ²¡æ‰¾åˆ°å®˜æ–¹æœ‰ç±»ä¼¼çš„ä»»åŠ¡ä¾›æˆ‘ä»¬ä¸€é”®è°ƒç”¨ï¼Œæ‰€ä»¥å†™äº†ä¸ªä»»åŠ¡ï¼š</p>
<pre><code class="language-Groovy">def variantName = &quot;dokitDebug&quot;
def soName = &quot;librtmp-jni.so&quot;
android.applicationVariants.all { variant -&gt;
    if (variant.name != variantName) return   // åªå¤„ç†ä½ å…³å¿ƒçš„å˜ä½“
    tasks.register(&quot;findSoOwner${variant.name.capitalize()}&quot;) {
        group = &quot;verification&quot;
        description = &quot;æŸ¥æ‰¾ ${soName} æ¥è‡ªå“ªä¸ª AAR&quot;
        def artifacts = variant.runtimeConfiguration.incoming.artifacts
        doLast {
            artifacts.artifacts.each { artifact -&gt;
                def file = artifact.file
                if (file.name.endsWith(&quot;.aar&quot;)) {
                    new java.util.zip.ZipFile(file).withCloseable { zf -&gt;
                        zf.entries().each { entry -&gt;
                            if (entry.name.endsWith(soName)) {
                                println &quot;Found ${soName} in ${artifact.id.componentIdentifier} (${file.name})&quot;
                            }
                        }
                    }
                }
            }
        }
    }
}
</code></pre>
<p>å°†æœ€å¼€å§‹çš„ä¸¤ä¸ªå˜é‡è¦ä¿®æ”¹ä¸ºè‡ªå·±å®é™…é¡¹ç›®ä¸­çš„å†…å®¹ï¼Œæ¯”å¦‚æˆ‘è¿™é‡Œå°±åœ¨ä¸€ä¸ªåä¸º <code>dokitDebug</code> çš„å˜ä½“ä¸‹æŸ¥è¯¢ <code>librtmp-jni.so</code> è¿™ä¸ª SO çš„æ¥æºï¼Œåªéœ€åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œå‘½ä»¤ï¼š</p>
<pre><code class="language-bash">âœ   ./gradlew :app:findSoOwner
</code></pre>
<p>å°±å¯ä»¥å¾—åˆ°ä»¥ä¸‹è¾“å‡ºï¼š</p>
<pre><code class="language-bash">&gt; Task :app:findSoOwnerDokitDebug
Found librtmp-jni.so in io.antmedia:rtmp-client:3.2.0 (rtmp-client-3.2.0.aar)
Found librtmp-jni.so in io.antmedia:rtmp-client:3.2.0 (rtmp-client-3.2.0.aar)
Found librtmp-jni.so in io.antmedia:rtmp-client:3.2.0 (rtmp-client-3.2.0.aar)
Found librtmp-jni.so in io.antmedia:rtmp-client:3.2.0 (rtmp-client-3.2.0.aar)
</code></pre>
<p>æˆ‘ä»¬å¯ä»¥åœ¨ç»“æœä¸­çœ‹åˆ°æŸ¥æ‰¾çš„ SO åº“æ¥æºäºå“ªä¸ªä¾èµ–ï¼Œç»“æœå¯èƒ½ä¼šè¾“å‡ºå¤šæ¬¡ã€‚</p>
<p>æŸ¥è¯¢åˆ°çš„ä¾èµ–ä¹Ÿè®¸å¹¶ä¸æ˜¯ä½ è‡ªå·±æ·»åŠ çš„ï¼Œè¿™æ—¶å€™åªéœ€å†ä½¿ç”¨ä¸Šä¸€èŠ‚æåˆ°çš„å‘½ä»¤æ‰“å°ä¾èµ–æ ‘ï¼Œå°±å¯ä»¥è¿½è¸ªåˆ°æ ¹ä¾èµ–äº†ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ç”¨ DataStore å°†ä½ æ‹‰å‡º SharedPreferences æ³¥æ½­]]></title>
        <id>https://LiarrDev.github.io/post/DataStore-Pull-You-Out-of-SharedPreferences-Quagmire/</id>
        <link href="https://LiarrDev.github.io/post/DataStore-Pull-You-Out-of-SharedPreferences-Quagmire/">
        </link>
        <updated>2025-09-16T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<h1 id="ç®€ä»‹">ç®€ä»‹</h1>
<p>DataStore æ˜¯ä¸€ç§æ•°æ®å­˜å‚¨è§£å†³æ–¹æ¡ˆï¼Œå…è®¸æ‚¨ä½¿ç”¨ <a href="https://liarrdev.github.io/post/Protocol-Buffers-Usage-on-Android">ProtoBuf</a> å­˜å‚¨é”®å€¼å¯¹æˆ–ç±»å‹åŒ–å¯¹è±¡ï¼Œç”± Android å®˜æ–¹åœ¨ 2020 å¹´æ¨å‡ºï¼Œå¹¶åœ¨ 2021 å¹´æ­£å¼å‘å¸ƒçš„åº“ï¼Œæ—¨åœ¨æ›¿ä»£æœå½¹å¤šå¹´çš„ SharedPreferencesã€‚</p>
<h1 id="sharedpreferences-çš„ç¼ºé™·">SharedPreferences çš„ç¼ºé™·</h1>
<ul>
<li>æ–‡ä»¶æ•°æ®çš„è¯»å–åŠ é”ï¼Œå¦‚æœ SharedPreferences æ–‡ä»¶æœªè¢«åŠ è½½æˆ–è§£æåˆ°å†…å­˜ä¸­ï¼Œè¯»å†™æ“ä½œéƒ½éœ€è¦ç­‰å¾…ï¼Œå¯èƒ½ä¼šå¯¹ UI çº¿ç¨‹æµç•…åº¦é€ æˆä¸€å®šå½±å“ï¼Œç”šè‡³ANR.</li>
<li>åœ¨ä¿å­˜æ•°æ®æ—¶ï¼Œæ— è®ºæ˜¯ <code>commit()</code> è¿˜æ˜¯ <code>apply()</code> éƒ½æœ‰å¯èƒ½å¼•å‘ ANR é—®é¢˜ã€‚</li>
<li>æ²¡æœ‰é”™è¯¯æç¤ºæœºåˆ¶ã€‚</li>
</ul>
<h1 id="datastore-çš„ä¼˜ç‚¹">DataStore çš„ä¼˜ç‚¹</h1>
<ul>
<li>åŸºäº Flow å®ç°ï¼Œä¿è¯ä¸»çº¿ç¨‹çš„å®‰å…¨æ€§ã€‚</li>
<li>ä»¥äº‹åŠ¡æ–¹å¼å¤„ç†æ›´æ–°æ•°æ®ã€‚</li>
<li>å¯ä»¥ç›‘å¬åˆ°æ“ä½œæˆåŠŸæˆ–è€…å¤±è´¥ç»“æœã€‚</li>
<li>å¤šè¿›ç¨‹ä½¿ç”¨ã€‚</li>
</ul>
<h1 id="preferences-datastore-å’Œ-proto-datastore">Preferences DataStore å’Œ Proto DataStore</h1>
<p>DataStore æä¾›ä¸¤ç§ä¸åŒçš„å®ç°ï¼šPreferences DataStore å’Œ Proto DataStoreã€‚</p>
<ul>
<li>Preferences DataStore ä½¿ç”¨é”®å­˜å‚¨å’Œè®¿é—®æ•°æ®ã€‚æ­¤å®ç°ä¸éœ€è¦é¢„å®šä¹‰çš„æ¶æ„ï¼Œä¹Ÿä¸ç¡®ä¿ç±»å‹å®‰å…¨ã€‚</li>
<li>Proto DataStore å°†æ•°æ®ä½œä¸ºè‡ªå®šä¹‰æ•°æ®ç±»å‹çš„å®ä¾‹è¿›è¡Œå­˜å‚¨ã€‚æ­¤å®ç°è¦æ±‚æ‚¨ä½¿ç”¨ <a href="https://liarrdev.github.io/post/Protocol-Buffers-Usage-on-Android">ProtoBuf</a> æ¥å®šä¹‰æ¶æ„ï¼Œä½†å¯ä»¥ç¡®ä¿ç±»å‹å®‰å…¨ã€‚</li>
</ul>
<h1 id="preferences-datastore">Preferences DataStore</h1>
<p>Preferences DataStore ç”¨äºå­˜å‚¨é”®å€¼å¯¹ï¼Œç›¸å½“äº SharedPreferences çš„æ”¹è‰¯ç‰ˆã€‚</p>
<pre><code class="language-kotlin">dependencies {
    implementation(&quot;androidx.datastore:datastore-preferences:1.1.0&quot;)
}
</code></pre>
<p>å®ä¾‹ï¼š</p>
<pre><code class="language-kotlin">// At the top level of your kotlin file:
val Context.dataStore: DataStore&lt;Preferences&gt; by preferencesDataStore(name = &quot;settings&quot;)
</code></pre>
<p>è¯»å–ï¼š</p>
<pre><code class="language-kotlin">val EXAMPLE_COUNTER = intPreferencesKey(&quot;example_counter&quot;)
val exampleCounterFlow: Flow&lt;Int&gt; = context.dataStore.data.map { preferences -&gt;
    // No type safety.
    preferences[EXAMPLE_COUNTER] ?: 0
}
</code></pre>
<p>æ”¯æŒçš„ç±»å‹åŸºæœ¬ä¸ SharedPreferences ä¸€è‡´ã€‚</p>
<p>å†™å…¥ï¼š</p>
<pre><code class="language-kotlin">suspend fun incrementCounter() {
    context.dataStore.edit { settings -&gt;
        val currentCounterValue = settings[EXAMPLE_COUNTER] ?: 0
        settings[EXAMPLE_COUNTER] = currentCounterValue + 1
    }
}
</code></pre>
<p>è½¬æ¢å—ä¸­çš„æ‰€æœ‰ä»£ç å‡è¢«è§†ä¸ºå•ä¸ªäº‹åŠ¡ã€‚</p>
<h1 id="proto-datastore">Proto DataStore</h1>
<p>Proto DataStore ç”¨äºå­˜å‚¨ç±»å‹åŒ–å¯¹è±¡ï¼Œç›¸å½“äº SharedPreferences çš„å‡çº§ç‰ˆã€‚å®ƒä½¿ç”¨äº† <a href="https://liarrdev.github.io/post/Protocol-Buffers-Usage-on-Android">Protocol Buffers</a>ã€‚</p>
<pre><code class="language-kotlin">dependencies {
    implementation(&quot;androidx.datastore:datastore:1.1.0&quot;)
}
</code></pre>
<p>åœ¨ <code>app/src/main/proto/</code> ç›®å½•ä¸‹é¢„å®šä¹‰ï¼š</p>
<pre><code class="language-protobuf">// Settings.proto
syntax = &quot;proto3&quot;;

option java_package = &quot;com.example.application&quot;;
option java_multiple_files = true;

message Settings {
  int32 example_counter = 1;
}
</code></pre>
<p>ç”¨äºå‘ŠçŸ¥ DataStore å¦‚ä½•è¯»å–å’Œå†™å…¥æ•°æ®çš„åºåˆ—åŒ–å™¨ï¼š</p>
<pre><code class="language-kotlin">object SettingsSerializer : Serializer&lt;Settings&gt; {

    override val defaultValue: Settings = Settings.getDefaultInstance()

    override suspend fun readFrom(input: InputStream): Settings {
        try {
            return Settings.parseFrom(input)
        } catch (e: InvalidProtocolBufferException) {
            throw CorruptionException(&quot;Cannot read proto.&quot;, e)
        }
    }

    override suspend fun writeTo(t: Settings, output: OutputStream) = t.writeTo(output)
}
</code></pre>
<p>å®ä¾‹ï¼š</p>
<pre><code class="language-kotlin">// At the top level of your kotlin file:
val Context.settingsDataStore: DataStore&lt;Settings&gt; by dataStore(
    fileName = &quot;settings.pb&quot;,
    serializer = SettingsSerializer
)
</code></pre>
<p>è¯»å–ï¼š</p>
<pre><code class="language-kotlin">val exampleCounterFlow: Flow&lt;Int&gt; = context.settingsDataStore.data.map { settings -&gt;
    // The exampleCounter property is generated from the proto schema.
    settings.exampleCounter
}
</code></pre>
<p>å†™å…¥ï¼š</p>
<pre><code class="language-kotlin">suspend fun incrementCounter() {
    context.settingsDataStore.updateData {
        it.toBuilder()
            .setExampleCounter(it.exampleCounter + 1)
            .build()
    }
}
</code></pre>
<p>åŒæ ·ä»¥äº‹åŠ¡æ–¹å¼æ›´æ–°æ•°æ®ã€‚</p>
<h1 id="ä»-sharedpreferences-ä¸­è¿ç§»">ä» SharedPreferences ä¸­è¿ç§»</h1>
<pre><code class="language-kotlin">private val Context.migrationDataStore: DataStore&lt;Preferences&gt; by preferencesDataStore(
    name = PREF_FILE_NAME,
    produceMigrations = {
        listOf(SharedPreferencesMigration(it, PREF_FILE_NAME))
    }
)
</code></pre>
<p>æ•°æ®çš„è¿ç§»åœ¨åˆ›å»º DataStore çš„è¿‡ç¨‹ä¸­è‡ªåŠ¨å®Œæˆï¼Œè¿ç§»å®Œæˆåï¼ŒåŸ SharedPreferences çš„ XML æ–‡ä»¶ä¼šè¢«åˆ é™¤ã€‚</p>
<h1 id="å¯¹æ¯”-mmkv">å¯¹æ¯” MMKV</h1>
<p>MMKV æ˜¯å¾®ä¿¡å›¢é˜Ÿå¼€æºçš„åŸºäº mmap å†…å­˜æ˜ å°„çš„ Key-Value ç»„ä»¶ï¼Œåº•å±‚åºåˆ—åŒ–ä¸ååºåˆ—åŒ–åŒæ ·ä½¿ç”¨ <a href="https://liarrdev.github.io/post/Protocol-Buffers-Usage-on-Android">ProtoBuf</a>ï¼Œæ€§èƒ½é«˜ï¼Œç¨³å®šæ€§å¼ºã€‚</p>
<p>è™½ç„¶ MMKV çš„åˆè¡·å¹¶ä¸æ˜¯æ›¿ä»£ SharedPreferencesï¼Œä½†æ˜¯åŒæ ·ä½œä¸º Key-Value ç»„ä»¶ï¼Œå¤§å¤šæ•°äººéƒ½å°† MMKV è§†ä¸º SharedPreferences çš„æ›¿ä»£å“ã€‚</p>
<p>å®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿå¯¹ MMKV å’Œ SharedPreferences çš„æ€§èƒ½è¿›è¡Œäº†å¯¹æ¯”ï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://LiarrDev.github.io/post-images/1757255479084.png" alt="MMKV vs SP" loading="lazy"></figure>
<p>äº‹å®ä¸Šï¼ŒMMKV å¹¶ä¸æ˜¯ä»»ä½•æ—¶å€™éƒ½æ›´å¼ºã€‚ç”±äºå†…å­˜æ˜ å°„è¿™ç§æ–¹æ¡ˆæ˜¯è‡ªè¡Œç®¡ç†ä¸€å—ç‹¬ç«‹çš„å†…å­˜ï¼Œæ‰€ä»¥å®ƒåœ¨å°ºå¯¸çš„ä¼¸ç¼©ä¸Šé¢å°±æ¯”è¾ƒå—é™ï¼Œè¿™å°±å¯¼è‡´å®ƒåœ¨å†™å¤§ä¸€ç‚¹çš„æ•°æ®æ—¶ï¼Œé€Ÿåº¦ä¼šæ…¢ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œè¯¥å†™å…¥è€—æ—¶å¯¹äºæ­£å¸¸å¼€å‘æ¥è¯´å¹¶éç‰¹åˆ«é‡è¦ï¼Œç•Œé¢çš„æµç•…åº¦æ›´åœ¨æ„ä¸»çº¿ç¨‹çš„è€—æ—¶ï¼Œè€Œ SharedPreferences æœ¬èº«ä¹Ÿæä¾›äº†å¼‚æ­¥å†™å…¥çš„ APIï¼Œæ‰€ä»¥å®ƒä»¬éƒ½è¶³å¤Ÿå¿«äº†ã€‚ä½† MMKV çš„è¯ç”Ÿåœºæ™¯å†³å®šäº†ï¼Œå®ƒæ›´åœ¨æ„åŒæ­¥å¤„ç†æœºåˆ¶ä¸‹çš„è€—æ—¶ã€‚</p>
<p>MMKV è¿˜æœ‰ä¸€ä¸ªç¼ºé™·â€”â€”ä¸¢æ•°æ®ã€‚æ“ä½œç³»ç»Ÿåœ¨å¾€ç£ç›˜å†™æ•°æ®çš„è¿‡ç¨‹ä¸­å‘ç”Ÿæ„å¤–éƒ½ä¼šå¯¼è‡´æ–‡ä»¶æŸåï¼Œè¿™ç§é—®é¢˜ä¸å¯é¿å…ã€‚MMKV è™½ç„¶ç”±äºåº•å±‚æœºåˆ¶çš„åŸå› ï¼Œåœ¨ç¨‹åºå´©æºƒçš„æ—¶å€™ä¸ä¼šå½±å“æ•°æ®å¾€ç£ç›˜çš„å†™å…¥ï¼Œä½†æ–­ç”µå…³æœºä¹‹ç±»çš„æ“ä½œç³»ç»Ÿçº§åˆ«çš„å´©æºƒï¼ŒMMKV å°±æ²¡åŠæ³•äº†ï¼Œæ–‡ä»¶ç…§æ ·ä¼šæŸåã€‚</p>
<p>å¯¹äºè¿™ç§æ–‡ä»¶æŸåï¼ŒSharedPreferences å’Œ DataStore çš„åº”å¯¹æ–¹å¼æ˜¯åœ¨æ¯æ¬¡å†™å…¥æ–°æ•°æ®ä¹‹å‰éƒ½å¯¹ç°æœ‰æ–‡ä»¶åšä¸€æ¬¡è‡ªåŠ¨å¤‡ä»½ï¼Œè¿™æ ·åœ¨å‘ç”Ÿäº†æ„å¤–å‡ºç°äº†æ–‡ä»¶æŸåä¹‹åï¼Œå®ƒä»¬å°±ä¼šæŠŠå¤‡ä»½çš„æ•°æ®æ¢å¤è¿‡æ¥ã€‚</p>
<p>è€Œ MMKVï¼Œæ²¡æœ‰è¿™ç§è‡ªåŠ¨çš„å¤‡ä»½å’Œæ¢å¤ï¼Œé‚£ä¹ˆå½“æ–‡ä»¶å‘ç”Ÿäº†æŸåï¼Œæ•°æ®å°±ä¸¢äº†ï¼Œä¹‹å‰ä¿å­˜çš„å„ç§ä¿¡æ¯åªèƒ½è¢«é‡ç½®ã€‚æ®å®˜æ–¹ç»Ÿè®¡ï¼Œ<a href="https://github.com/Tencent/MMKV/wiki/design#%E6%95%B0%E6%8D%AE%E6%9C%89%E6%95%88%E6%80%A7">iOS å¾®ä¿¡å¹³å‡çº¦æœ‰ 70 ä¸‡æ—¥æ¬¡çš„æ•°æ®æ ¡éªŒä¸é€šè¿‡</a>ã€‚</p>
<p>å› æ­¤ MMKV æ›´é€‚åˆåŒæ­¥é«˜é¢‘å†™å…¥éé‡è¦ä¿¡æ¯çš„åœºæ™¯ã€‚</p>
<h1 id="å‚è€ƒå†…å®¹">å‚è€ƒå†…å®¹</h1>
<ul>
<li><a href="https://developer.android.google.cn/topic/libraries/architecture/datastore">åº”ç”¨æ¶æ„ï¼šæ•°æ®å±‚ - DataStore - Android å¼€å‘è€… | App architecture | Android Developers</a></li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[åœ¨ Android ä¸­ä½¿ç”¨ Protocol Buffers]]></title>
        <id>https://LiarrDev.github.io/post/Protocol-Buffers-Usage-on-Android/</id>
        <link href="https://LiarrDev.github.io/post/Protocol-Buffers-Usage-on-Android/">
        </link>
        <updated>2025-08-24T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<h1 id="ç®€ä»‹">ç®€ä»‹</h1>
<p>Protocol Buffersï¼ˆç®€ç§° Protobufï¼‰æ˜¯ Google å¼€å‘çš„ä¸€ç§ç‹¬ç«‹äºè¯­è¨€å’Œå¹³å°çš„ç»“æ„åŒ–æ•°æ®åºåˆ—åŒ–å¯æ‰©å±•æœºåˆ¶ã€‚å®ƒä¸ JSON ç±»ä¼¼ï¼Œåªæ˜¯ä½“ç§¯æ›´å°ã€é€Ÿåº¦æ›´å¿«ï¼Œè€Œä¸”èƒ½ç”Ÿæˆæœ¬åœ°è¯­è¨€ç»‘å®šã€‚æ‚¨åªéœ€å®šä¹‰ä¸€æ¬¡æ•°æ®çš„ç»“æ„åŒ–æ–¹å¼ï¼Œç„¶åå°±å¯ä»¥ä½¿ç”¨ç‰¹æ®Šç”Ÿæˆçš„æºä»£ç ï¼Œä½¿ç”¨å„ç§è¯­è¨€è½»æ¾åœ°å°†ç»“æ„åŒ–æ•°æ®å†™å…¥å„ç§æ•°æ®æµæˆ–ä»å„ç§æ•°æ®æµä¸­è¯»å–ç»“æ„åŒ–æ•°æ®ã€‚</p>
<p>Google æä¾›äº†å¤šç§è¯­è¨€çš„å®ç°ï¼Œæ¯ä¸€ç§å®ç°éƒ½åŒ…å«äº†ç›¸åº”è¯­è¨€çš„ç¼–è¯‘å™¨ä»¥åŠåº“æ–‡ä»¶ã€‚ç”±äºå®ƒæ˜¯ä¸€ç§äºŒè¿›åˆ¶çš„æ ¼å¼ï¼Œæ¯”ä½¿ç”¨ XML è¿›è¡Œæ•°æ®äº¤æ¢å¿«è®¸å¤šï¼ˆä½“ç§¯å° 3ï½10 å€ï¼Œé€Ÿåº¦å¿« 20ï½100 å€ï¼‰ã€‚ä½œä¸ºä¸€ç§æ•ˆç‡å’Œå…¼å®¹æ€§éƒ½å¾ˆä¼˜ç§€çš„äºŒè¿›åˆ¶æ•°æ®ä¼ è¾“æ ¼å¼ï¼Œå¯ä»¥ç”¨äºè¯¸å¦‚ç½‘ç»œä¼ è¾“ã€é…ç½®æ–‡ä»¶ã€æ•°æ®å­˜å‚¨ç­‰è¯¸å¤šé¢†åŸŸã€‚</p>
<p>å®ƒæœ‰ä¸€ä¸ªéå¸¸æ£’çš„ç‰¹æ€§ï¼Œå³â€œå‘åâ€å…¼å®¹æ€§å¥½ï¼Œäººä»¬ä¸å¿…ç ´åå·²éƒ¨ç½²çš„ã€ä¾é â€œè€â€æ•°æ®æ ¼å¼çš„ç¨‹åºå°±å¯ä»¥å¯¹æ•°æ®ç»“æ„è¿›è¡Œå‡çº§ã€‚è¿™æ ·æ‚¨çš„ç¨‹åºå°±å¯ä»¥ä¸å¿…æ‹…å¿ƒå› ä¸ºæ¶ˆæ¯ç»“æ„çš„æ”¹å˜è€Œé€ æˆçš„å¤§è§„æ¨¡çš„ä»£ç é‡æ„æˆ–è€…è¿ç§»çš„é—®é¢˜ã€‚å› ä¸ºæ·»åŠ æ–°çš„æ¶ˆæ¯ä¸­çš„ field å¹¶ä¸ä¼šå¼•èµ·å·²ç»å‘å¸ƒçš„ç¨‹åºçš„ä»»ä½•æ”¹å˜ã€‚</p>
<p>Protobuf ä¸ XML å’Œ JSON ç›¸æ¯”ä¹Ÿæœ‰ä¸è¶³ä¹‹å¤„ã€‚ç”±äº XML å’Œ JSON å…·æœ‰æŸç§ç¨‹åº¦ä¸Šçš„è‡ªè§£é‡Šæ€§ï¼Œå®ƒå¯ä»¥è¢«äººç›´æ¥è¯»å–ç¼–è¾‘ï¼Œåœ¨è¿™ä¸€ç‚¹ä¸Š Protobuf ä¸è¡Œï¼Œå®ƒä»¥äºŒè¿›åˆ¶çš„æ–¹å¼å­˜å‚¨ã€‚</p>
<h1 id="è¯­æ³•">è¯­æ³•</h1>
<pre><code class="language-ProtoBuf">syntax = &quot;proto3&quot;;

message SearchRequest {
  string query = 1;
  int32 page_number = 2;
  int32 results_per_page = 3;
}
</code></pre>
<ul>
<li>ç¬¬ä¸€è¡Œè¯´æ˜ä½¿ç”¨çš„æ˜¯ proto3 è¯­æ³•ï¼šå¦‚æœä¸è¿™æ ·åšï¼ŒProtobuf ç¼–è¯‘å™¨ä¼šè®¤ä¸ºä½¿ç”¨çš„æ˜¯ proto2ã€‚è¿™å¿…é¡»æ˜¯æ–‡ä»¶ä¸­ç¬¬ä¸€è¡Œéç©ºã€éæ³¨é‡Šçš„å†…å®¹ã€‚</li>
<li>SearchRequest æŠ¥æ–‡å®šä¹‰æŒ‡å®šäº†ä¸‰ä¸ªå­—æ®µï¼ˆåç§°/å€¼å¯¹ï¼‰ï¼Œæ¯ä¸ªå­—æ®µä»£è¡¨ä¸€æ¡è¦åŒ…å«åœ¨æ­¤ç±»æŠ¥æ–‡ä¸­çš„æ•°æ®ã€‚æ¯ä¸ªå­—æ®µéƒ½æœ‰åç§°å’Œç±»å‹ã€‚</li>
<li>é¡»ä¸ºä¿¡æ¯å®šä¹‰ä¸­çš„æ¯ä¸ªå­—æ®µèµ‹äºˆä¸€ä¸ªä»‹äº <code>1</code> åˆ° <code>536,870,911</code>ï¼ˆ<span class="katex"><span class="katex-mathml"><math><semantics><mrow><msup><mn>2</mn><mn>29</mn></msup><mo>âˆ’</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">2^{29} -1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">2</span><span class="mord mtight">9</span></span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">âˆ’</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">1</span></span></span></span>ï¼‰ä¹‹é—´çš„æ•°å­—ï¼Œåœ¨è¯¥æŠ¥æ–‡ä¸­å¿…é¡»å”¯ä¸€ï¼Œç¼–å· <code>19,000</code> è‡³ <code>19,999</code> ä¿ç•™ç»™ Protocol Buffers å®ç°ã€‚</li>
<li>ä¸èƒ½ä½¿ç”¨ä»»ä½•å…ˆå‰ä¿ç•™çš„ç¼–å·ã€‚æ›´æ”¹å­—æ®µç¼–å·ç›¸å½“äºåˆ é™¤è¯¥å­—æ®µï¼Œç„¶ååˆ›å»ºä¸€ä¸ªç±»å‹ç›¸åŒä½†ç¼–å·ä¸åŒçš„æ–°å­—æ®µã€‚åˆ é™¤å­—æ®µå®šä¹‰æ—¶å¿…é¡»ä¿ç•™å·²åˆ é™¤çš„å­—æ®µç¼–å·ï¼Œå¦‚æœä¸ä¿ç•™å­—æ®µç¼–å·ï¼Œå¼€å‘äººå‘˜å°†æ¥æœ‰å¯èƒ½é‡æ–°ä½¿ç”¨è¯¥ç¼–å·ã€‚</li>
</ul>
<h1 id="ä½¿ç”¨">ä½¿ç”¨</h1>
<p><code>libs.versions.toml</code> å®šä¹‰ç‰ˆæœ¬ï¼š</p>
<pre><code class="language-TOML">[libraries]
protobuf-protoc = { group = &quot;com.google.protobuf&quot;, name = &quot;protoc&quot;, version.ref = &quot;protobuf&quot; }
protobuf-javalite = { group = &quot;com.google.protobuf&quot;, name = &quot;protobuf-javalite&quot;, version.ref = &quot;protobuf&quot; }

[plugins]
googleProtobuf = { id = &quot;com.google.protobuf&quot;, version.ref = &quot;protobufPlugin&quot; }
</code></pre>
<p>é¡¹ç›®çš„ <code>build.gradle.kts</code>ï¼š</p>
<pre><code class="language-kotlin">plugins {
    // ...
    alias(libs.plugins.googleProtobuf) apply false
}
</code></pre>
<p>app çš„ <code>build.gradle.kts</code>ï¼š</p>
<pre><code class="language-kotlin">import com.google.protobuf.gradle.proto

plugins {
    // ...
    alias(libs.plugins.googleProtobuf)
}

android {
    //...
    sourceSets {
        getByName(&quot;main&quot;).java.srcDir(&quot;src/main/java&quot;)
        getByName(&quot;main&quot;).proto {
            srcDir(&quot;src/main/proto&quot;)
            include(&quot;**/*.proto&quot;)
        }
    }
}
protobuf {
    protoc { 
        artifact = libs.protoc.get().toString()
    }
    plugins {
        generateProtoTasks {
            all().forEach {
                it.builtins {
                    create(&quot;java&quot;) {
                        option(&quot;lite&quot;)
                    }
                }
            }
        }
    }
}

dependencies {
    // ...
    implementation(libs.protobuf.protoc)
    implementation(libs.protobuf.javalite)
}
</code></pre>
<p>æ··æ·†é…ç½®ï¼š</p>
<pre><code>-keep class * extends com.google.protobuf.GeneratedMessageLite { *; }
</code></pre>
<p>åœ¨ <code>app/src/main/proto</code> ç›®å½•ä¸­åˆ›å»º proto æ–‡ä»¶ï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://LiarrDev.github.io/post-images/1755443506237.png" alt="Proto File" loading="lazy"></figure>
<p>å†…å®¹å¦‚ä¸‹ï¼š</p>
<pre><code class="language-ProtoBuf">syntax = &quot;proto3&quot;;  // å£°æ˜ proto åè®®ç‰ˆæœ¬
package com.example.proto;  // å®šä¹‰ Protobuf è‡ªåŠ¨ç”Ÿæˆç±»çš„åŒ…å
option java_package = &quot;com.example.proto&quot;;  // Java ç±»æ‰€åœ¨çš„åŒ…å
option java_outer_classname= &quot;SearchRequestProto&quot;;  // å®šä¹‰ Protobuf è‡ªåŠ¨ç”Ÿæˆç±»çš„ç±»å

message SearchRequest {
  string query = 1;
  int32 page_number = 2;
  int32 results_per_page = 3;
}
</code></pre>
<p>Build é¡¹ç›®ï¼Œä¼šåœ¨ <code>app/build/generated/source/proto</code> ä¸­ç”Ÿæˆå¯¹åº”çš„ Java æ–‡ä»¶ï¼š</p>
<figure data-type="image" tabindex="2"><img src="https://LiarrDev.github.io/post-images/1755443529830.png" alt="Generated Java File" loading="lazy"></figure>
<p>ç”Ÿæˆçš„ Java æ–‡ä»¶å†…å®¹å¤ªé•¿ï¼Œå°±ä¸è´´åœ¨è¿™é‡Œäº†ï¼Œä½†æ˜¯ç»“æ„ç®€å•ï¼Œæ— éå°±æ˜¯ä¸€å † Getter å’Œ Setter ä»¥åŠä¸€äº›è§£ææ–¹æ³•ï¼Œç›¸ä¿¡ä½ ä¹Ÿå¯ä»¥è½»æ˜“è¯»æ‡‚ã€‚</p>
<p>æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨ä»£ç ä¸­è°ƒç”¨å®ƒï¼š</p>
<pre><code class="language-kotlin">@Test
fun proto() {
    // åºåˆ—åŒ–
    val request = SearchRequestProto.SearchRequest.newBuilder()
        .setQuery(&quot;Proto&quot;)
        .setPageNumber(1)
        .setResultsPerPage(10)
        .build()
    val bytes = request.toByteArray()

    // ååºåˆ—åŒ–
    try {
        val result = SearchRequestProto.SearchRequest.parseFrom(bytes)
        val query = result.query
        val pageNumber = result.pageNumber
        val resultPerPage = result.resultsPerPage
    } catch (e: Exception) {
        e.printStackTrace()
    }
}
</code></pre>
<p>åºåˆ—åŒ–åˆ©ç”¨çš„æ˜¯ <a href="https://liarrdev.github.io/post/Design-Pattern-Builder">Builder æ¨¡å¼</a>ï¼Œæ„å»ºæˆä¸€ä¸ª <code>SearchRequest</code> å¯¹è±¡åï¼Œå†å°†å…¶è½¬æ¢æˆ <code>ByteArray</code>ã€‚ååºåˆ—åŒ–åˆ™åˆ©ç”¨ <code>parseFrom()</code> æ–¹æ³•å°† <code>ByteArray</code> æˆ–è€… <code>InputStream</code> è½¬æˆ <code>SearchRequest</code> å¯¹è±¡ï¼Œ<code>parseFrom()</code> æ–¹æ³•å°±æ˜¯åœ¨ä¸Šæ–¹ç”Ÿæˆçš„ Java æ–‡ä»¶ä¸­è‡ªåŠ¨å¸®æˆ‘ä»¬æ’å…¥çš„æ–¹æ³•ã€‚</p>
<h1 id="å‚è€ƒå†…å®¹">å‚è€ƒå†…å®¹</h1>
<ul>
<li><a href="https://protobuf.dev/programming-guides/proto3/">Language Guide (proto 3) | Protocol Buffers Documentation</a></li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Design Pattern: Builder]]></title>
        <id>https://LiarrDev.github.io/post/Design-Pattern-Builder/</id>
        <link href="https://LiarrDev.github.io/post/Design-Pattern-Builder/">
        </link>
        <updated>2025-07-22T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<p>å»ºé€ è€…æ¨¡å¼ï¼ˆBuilder Patternï¼Œä¹Ÿå«ç”Ÿæˆå™¨æ¨¡å¼ï¼‰æ˜¯æœ€å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ä¹‹ä¸€ï¼Œå®ƒä¸ä¹‹å‰ä»‹ç»çš„ã€<a href="https://liarrdev.github.io/post/Design-Pattern-Singleton/">Design Pattern: Singleton</a>ã€å’Œã€<a href="https://liarrdev.github.io/post/Design-Pattern-Factory/">Design Pattern: Factory</a>ã€éƒ½å±äºåˆ›å»ºç±»å‹çš„è®¾è®¡æ¨¡å¼ã€‚</p>
<p>å®ƒå¯ä»¥å°†å¤æ‚å¯¹è±¡çš„æ„å»ºè¿‡ç¨‹æŠ½è±¡å‡ºæ¥ï¼Œä½¿è¿™ä¸ªæŠ½è±¡è¿‡ç¨‹çš„ä¸åŒå®ç°æ–¹æ³•å¯ä»¥æ„é€ å‡ºä¸åŒè¡¨ç°ï¼ˆå±æ€§ï¼‰çš„å¯¹è±¡ã€‚</p>
<p>åœ¨è®² Builder æ¨¡å¼å®ç°ä¹‹å‰ï¼Œå…ˆçœ‹çœ‹ä¹‹å‰æˆ‘ä»¬æ„å»ºå¤æ‚å¯¹è±¡æ—¶æ˜¯å¦‚ä½•ç¼–å†™çš„ã€‚</p>
<h1 id="æ„é€ å™¨é‡è½½telescoping-constructor-anti-pattern">æ„é€ å™¨é‡è½½ï¼ˆTelescoping Constructor anti-patternï¼‰</h1>
<pre><code class="language-java">public class Article {
    private String title;
    private String content;
    private String author;
    private Date date;
    public Article(String title, String content) { ... }
    public Article(String title, String content, String author) { ... }
    public Article(String title, String content, Date date) { ... }
    public Article(String title, String content, String author, Date date) { ... }
}
</code></pre>
<p>é€šè¿‡åœ¨æ„é€ å™¨ä¸­ä¼ é€’ä¸åŒæ•°é‡çš„å‚æ•°ï¼Œä»è€Œå®ç°æ„å»ºä¸åŒå±æ€§ç»„åˆçš„å¯¹è±¡ã€‚è¿™ç§æ–¹æ³•ç®€å•ç›´è§‚ï¼Œä½†éšç€å±æ€§å¢åŠ ï¼Œæ„é€ å™¨çš„å‚æ•°ç»„åˆå‘ˆæŒ‡æ•°çº§å¢é•¿ï¼Œä½ å°±å¾ˆéš¾è®°ä½å‚æ•°çš„é¡ºåºä»¥åŠåœ¨ç‰¹å®šæƒ…å†µä¸‹ä½ å¯èƒ½éœ€è¦çš„ç‰¹å®šæ„é€ å‡½æ•°ï¼Œéš¾ä»¥ç»´æŠ¤å’Œç†è§£ã€‚</p>
<p>Kotlin çš„å‡ºç°å€’æ˜¯å¾ˆå¤§ç¨‹åº¦ä¸Šè§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼š</p>
<pre><code class="language-kotlin">data class Article(
    val title: String = &quot;&quot;,
    val content: String = &quot;&quot;,
    val author: String = &quot;&quot;,
    val date: Date = Date()
)
</code></pre>
<p>å°½ç®¡å¦‚æ­¤ï¼Œå®ƒåœ¨æ‰©å±•æ€§ä¸Šè¿˜æ˜¯ç¨æœ‰æ¬ ç¼ºï¼Œæ¯”å¦‚åŒä¸€å±æ€§ä¸åŒç±»å‹çš„æ„é€ ï¼Œè¿™æ—¶å€™è¿˜æ˜¯è¦å›åˆ°æ„é€ å‡½æ•°é‡è½½çš„æ–¹æ¡ˆã€‚</p>
<pre><code class="language-kotlin">data class Article(
    val title: String = &quot;&quot;,
    val content: String = &quot;&quot;,
    val author: String = &quot;&quot;,
    val date: Date = Date()
) {
    constructor(
        title: String = &quot;&quot;,
        content: String = &quot;&quot;,
        author: String = &quot;&quot;,
        millis: Long = System.currentTimeMillis()
    ) : this(title, content, author, Date(millis))
}
</code></pre>
<h1 id="setter">Setter</h1>
<p>Setter æ–¹æ³•å¯ä»¥å¾ˆå¥½åœ°è§£å†³æ„é€ å‡½æ•°è†¨èƒ€çš„é—®é¢˜ï¼Œåªéœ€æ·»åŠ å¯¹åº”çš„é‡è½½æ–¹æ³•å³å¯ï¼š</p>
<pre><code class="language-kotlin">class Article {
    private var title: String = &quot;&quot;
    private var content: String = &quot;&quot;
    private var author: String = &quot;&quot;
    private var date: Date = Date()
    fun setTitle(title: String) { ... }
    fun setContent(content: String) { ... }
    fun setAuthor(author: String) { ... }
    fun setDate(date: Date) { this.date = date }
    fun setDate(millis: Long) { this.date = Date(millis) }
}
</code></pre>
<p>ä½¿ç”¨ Setter é€ä¸ªè®¾ç½®å±æ€§çš„å€¼ï¼Œçµæ´»æ€§è¾ƒå¼ºï¼Œä½†ä¹Ÿå¯èƒ½å¯¼è‡´å¯¹è±¡åœ¨æ„å»ºè¿‡ç¨‹ä¸­å¤„äºä¸å®Œæ•´çŠ¶æ€ï¼Œå¯å˜æ€§å¸¦æ¥çš„çº¿ç¨‹å®‰å…¨æ€§é—®é¢˜ï¼Œæ— æ³•ä¿è¯å¯¹è±¡çš„ä¸å˜æ€§ã€‚</p>
<h1 id="å»ºé€ è€…æ¨¡å¼">å»ºé€ è€…æ¨¡å¼</h1>
<p>å»ºé€ è€…æ¨¡å¼é€šè¿‡ä¸€ä¸ªç‹¬ç«‹çš„ Builder ç±»è´Ÿè´£æ„å»ºå¯¹è±¡ï¼Œå¯ä»¥ç¡®ä¿å¯¹è±¡åœ¨æ„å»ºæ—¶å¤„äºåˆæ³•çŠ¶æ€ã€‚</p>
<p>å»ºé€ è€…æ¨¡å¼åŒ…å«å¦‚ä¸‹è§’è‰²ï¼š</p>
<ul>
<li>Builderï¼šæŠ½è±¡å»ºé€ è€…</li>
<li>ConcreteBuilderï¼šå…·ä½“å»ºé€ è€…</li>
<li>Directorï¼šæŒ‡æŒ¥è€…</li>
<li>Productï¼šäº§å“è§’è‰²</li>
</ul>
<figure data-type="image" tabindex="1"><img src="https://LiarrDev.github.io/post-images/1752405338134.png" alt="" loading="lazy"></figure>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ç¤ºä¾‹ï¼š</p>
<pre><code class="language-kotlin">/** &quot;Product&quot; */
data class Pizza(var dough: String = &quot;&quot;, var sauce: String = &quot;&quot;, var topping: String = &quot;&quot;)

/** &quot;Abstract Builder&quot; */
abstract class PizzaBuilder {
    lateinit var pizza: Pizza
        private set
    fun createPizza() { pizza = Pizza() }
    abstract fun buildDough()
    abstract fun buildSauce()
    abstract fun buildTopping()
}

/** &quot;Concrete Builder&quot; */
class HawaiianPizzaBuilder : PizzaBuilder() {
    override fun buildDough() {
        pizza.dough = &quot;cross&quot;
    }
    override fun buildSauce() {
        pizza.sauce = &quot;mild&quot;
    }
    override fun buildTopping() {
        pizza.topping = &quot;ham + pineapple&quot;
    }
}

/** &quot;Concrete Builder&quot; */
class SpicyPizzaBuilder : PizzaBuilder() {
    override fun buildDough() {
        pizza.dough = &quot;pan baked&quot;
    }
    override fun buildSauce() {
        pizza.sauce = &quot;hot&quot;
    }
    override fun buildTopping() {
        pizza.topping = &quot;pepperoni + salami&quot;
    }
}

/** &quot;Director&quot; */
class Chef {
    lateinit var pizzaBuilder: PizzaBuilder
    fun getPizza() = pizzaBuilder.pizza
    fun constructPizza() {
        pizzaBuilder.createPizza()
        pizzaBuilder.buildDough()
        pizzaBuilder.buildSauce()
        pizzaBuilder.buildTopping()
    }
}

fun main() {
    val chef = Chef()
    val hawaiianBuilder = HawaiianPizzaBuilder()
    val spicyPizzaBuilder = SpicyPizzaBuilder()
    chef.pizzaBuilder = hawaiianBuilder
    chef.constructPizza()
    val pizza = chef.getPizza()
}
</code></pre>
<p>è¿™é‡Œæ„å»ºäº†ä¸€ä¸ªå¨å¸ˆåšæŠ«è¨äº†ä¾‹å­ï¼Œ<code>Chef</code> å¹¶ä¸ä¼šç›´æ¥æ„å»º <code>Pizza</code> å¯¹è±¡ï¼Œå› ä¸ºè¿™ä¸ªè¿‡ç¨‹å¾ˆå®¹æ˜“å‡ºé”™ï¼Œè€Œæ˜¯æ ¹æ®èœè°±ï¼Œä¹Ÿå°±æ˜¯ Builder å®ä¾‹æ¥åˆ¶ä½œï¼Œ<code>PizzaBuilder</code> æ˜¯ä¸ªæŠ½è±¡ç±»ï¼Œç”±å­ç±»æ¥å®ç°å…·ä½“çš„åˆ¶ä½œè¿‡ç¨‹ä¸­æ‰€éœ€çš„ææ–™ï¼Œ<code>Chef</code> æ— é¡»å…³å¿ƒåšè¿™ä¸ªæŠ«è¨éœ€è¦è èè¿˜æ˜¯ç«è…¿ï¼Œè¿™ä¸ªç”± <code>PizzaBuilder</code> æ„å»ºï¼Œ<code>Chef</code> æ‹¿åˆ°èœè°±ï¼ŒæŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤æ‰§è¡Œå³å¯ã€‚</p>
<p>ä»¥ä¸Šè¿™ä¸ªå°±æ˜¯å»ºé€ è€…æ¨¡å¼æ¯”è¾ƒå®˜æ–¹çš„ä¾‹å­ã€‚</p>
<p>æŠ½è±¡çš„å¼•å…¥ä¼¼ä¹å¾ˆå®¹æ˜“ä¼šä¸ä¹‹å‰ä»‹ç»çš„<a href="https://liarrdev.github.io/post/Design-Pattern-Factory/">å·¥å‚æ¨¡å¼</a>æ··æ·†ï¼Œ<a href="https://liarrdev.github.io/post/Design-Pattern-Factory/">å·¥å‚æ¨¡å¼</a>çš„ç›®çš„æ˜¯å®ç°å¤šæ€æ€§ï¼Œè€Œå»ºé€ è€…æ¨¡å¼çš„ç›®çš„æ˜¯æ‰¾åˆ°ä¸€ç§è§£å†³ä¼¸ç¼©æ„é€ å™¨åæ¨¡å¼çš„æ–¹æ³•ï¼Œå®ƒä½¿ç”¨ä¸€ä¸ªæ„é€ å™¨ï¼Œé€æ­¥æ¥æ”¶æ¯ä¸ªåˆå§‹åŒ–å‚æ•°ï¼Œç„¶åä¸€æ¬¡æ€§è¿”å›æ‰€æ„é€ çš„å¯¹è±¡ã€‚</p>
<p>ç®€å•æ¥è¯´ï¼Œä¸¤è€…éƒ½å¯ä»¥åˆ›å»ºå¤æ‚çš„å¯¹è±¡ï¼Œä¸»è¦åŒºåˆ«æ˜¯<a href="https://liarrdev.github.io/post/Design-Pattern-Factory/">å·¥å‚æ¨¡å¼</a>ç€é‡äºå¤šä¸ªäº§å“å¯¹è±¡ï¼Œä¸”äº§å“å¯¹è±¡æ˜¯ç«‹å³è¿”å›çš„ï¼Œè€Œå»ºé€ è€…æ¨¡å¼ç€é‡äºä¸€æ­¥æ­¥æ„é€ ä¸€ä¸ªå¤æ‚å¯¹è±¡ï¼Œäº§å“åœ¨æœ€åçš„ä¸€æ­¥è¿”å›ã€‚</p>
<p>å¦ä¸€æ–¹é¢ï¼Œè™½ç„¶åˆ©ç”¨å»ºé€ è€…æ¨¡å¼å¯ä»¥åˆ›å»ºå‡ºä¸åŒç±»å‹çš„äº§å“ï¼Œä½†æ˜¯å¦‚æœäº§å“ä¹‹é—´çš„å·®å¼‚å·¨å¤§ï¼Œåˆ™éœ€è¦ç¼–å†™å¤šä¸ªå»ºé€ è€…ç±»æ‰èƒ½å®ç°ï¼Œå¦‚æœè¿™æ—¶ç»“åˆ<a href="https://liarrdev.github.io/post/Design-Pattern-Factory/">å·¥å‚æ¨¡å¼</a>ä¼šæ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰æ‹©ã€‚</p>
<p>ä¸ºäº†æ›´å¥½åœ°ç†è§£å»ºé€ è€…æ¨¡å¼ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªå¯¹äº Android å¼€å‘è€…æ¥è¯´æ›´å¸¸è§çš„ä¾‹å­ï¼Œ<a href="https://liarrdev.github.io/post/Enjoy-OkHttp-in-One-Shot/"><code>OkHttp</code></a> ç½‘ç»œè¯·æ±‚åº“å†…éƒ¨å°±å¤§é‡åº”ç”¨äº†å»ºé€ è€…æ¨¡å¼ï¼Œä»¥åˆ›å»º <code>Request</code> ä¸ºä¾‹ï¼š</p>
<pre><code class="language-kotlin">object HttpUtils {
    private val client = OkHttpClient()
    fun doRequest(url: String) {
        val request = Request.Builder().url(url).build()
        client.newCall(request).enqueue(object : Callback {
            ...
        })
    }
}
</code></pre>
<p><code>Request</code> çš„æ„é€ æ–¹æ³•ä¸€å…± 5 ä¸ªå‚æ•°ï¼Œè¿˜æœ‰å…¶ä»–æˆå‘˜å˜é‡ï¼Œæˆ‘ä»¬é€šè¿‡å®ƒçš„é™æ€å†…éƒ¨ç±» <code>Builder</code> æŒ‰éœ€è®¾ç½®å®ƒçš„ <code>url</code> å’Œ <code>method</code> ç­‰å‚æ•°ï¼Œæœ€åè°ƒç”¨ <code>build()</code> æ–¹æ³•ï¼Œ<code>Builder</code> ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬æ„å»º <code>Request</code> å¯¹è±¡ã€‚</p>
<p>å¯ä»¥ç®€å•çœ‹çœ‹ <code>Request</code> çš„æºç ï¼š</p>
<pre><code class="language-kotlin">class Request internal constructor(
    @get:JvmName(&quot;url&quot;) val url: HttpUrl,
    @get:JvmName(&quot;method&quot;) val method: String,
    @get:JvmName(&quot;headers&quot;) val headers: Headers,
    @get:JvmName(&quot;body&quot;) val body: RequestBody?,
    internal val tags: Map&lt;Class&lt;*&gt;, Any&gt;
) {
    ...
    open class Builder {
        internal var url: HttpUrl? = null
        internal var method: String
        internal var headers: Headers.Builder
        internal var body: RequestBody? = null
        internal var tags: MutableMap&lt;Class&lt;*&gt;, Any&gt; = mutableMapOf()
        ...
        constructor() {
            this.method = &quot;GET&quot;
            this.headers = Headers.Builder()
        }
        open fun url(url: HttpUrl): Builder = apply {
            this.url = url
        }
        open fun url(url: String): Builder {
            val finalUrl: String = when {
                url.startsWith(&quot;ws:&quot;, ignoreCase = true) -&gt; {
                    &quot;http:${url.substring(3)}&quot;
                }
                url.startsWith(&quot;wss:&quot;, ignoreCase = true) -&gt; {
                    &quot;https:${url.substring(4)}&quot;
                }
                else -&gt; url
            }
            return url(finalUrl.toHttpUrl())
        }
        open fun build(): Request {
            return Request(
                checkNotNull(url) { &quot;url == null&quot; },
                method,
                headers.build(),
                body,
                tags.toImmutableMap()
            )
        }
    }
}
</code></pre>
<p>æˆ‘ä»¬è®¾ç½®çš„å‚æ•°ç»è¿‡å¤„ç†åé¦–å…ˆå­˜å‚¨åœ¨ <code>Builder</code> ä¸­ï¼Œè°ƒç”¨ <code>build()</code> æ–¹æ³•åˆ›å»º <code>Request</code> å¯¹è±¡æ—¶ç”¨å…¶æ„å»ºå®ä¾‹ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰é…ç½®åˆ™ä½¿ç”¨ <code>Builder</code> ä¸­è®¾å®šçš„é»˜è®¤å€¼ã€‚</p>
<p>åœ¨è¿™é‡Œï¼Œ<code>Builder</code> åŒæ—¶æ‰®æ¼”äº†ä¸Šæ–‡ä¸­æåˆ°çš„ Builderã€ConcreteBuilder è§’è‰²ï¼Œåœ¨ Builder æ¨¡å¼ä¸­å¦‚æœ ConcreteBuilder åªæœ‰ä¸€ä¸ªï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ä½¿ç”¨è¿™ç§å†™æ³•ï¼Œçœç•¥æŠ½è±¡ï¼Œç®€åŒ– Builder æ¨¡å¼çš„è®¾è®¡ã€‚</p>
<p>åŒæ—¶ï¼Œå› ä¸º <code>Builder</code> é‡Œçš„æ¯ä¸€ä¸ª Setter æ–¹æ³•éƒ½è¿”å›äº† <code>Builder</code> å¯¹è±¡æœ¬èº«ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨è°ƒç”¨çš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨é“¾å¼å†™æ³•ï¼Œæ›´åŠ ç®€æ´ã€‚</p>
<p>åœ¨ Android SDK ä¸­ä¹Ÿæ—¶å¸¸å¯ä»¥è§åˆ°å»ºé€ è€…æ¨¡å¼çš„èº«å½±ï¼Œæ¯”å¦‚å¸¸ç”¨çš„ <code>AlertDialog</code>ã€<code>Notification</code> ç­‰ï¼Œç”±äºå…¶æ¶‰åŠåˆ° UI ç›¸å…³çš„å¤„ç†é€»è¾‘ï¼Œä»£ç é‡è¾ƒå¤§ï¼Œå°±ä¸åœ¨è¿™é‡Œå±•å¼€äº†ï¼Œå¯è‡ªè¡Œé˜…è¯»æºç ç†è§£ã€‚</p>
<h1 id="ä¼˜ç¼ºç‚¹">ä¼˜ç¼ºç‚¹</h1>
<h2 id="ä¼˜ç‚¹">ä¼˜ç‚¹</h2>
<ul>
<li>æé«˜å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼šé€šè¿‡ä½¿ç”¨å»ºé€ è€…æ¨¡å¼ï¼Œä»£ç çš„å¯è¯»æ€§å’Œå¯ç»´æŠ¤æ€§å¾—åˆ°æé«˜ã€‚å»ºé€ è€…æ¨¡å¼å…è®¸å¼€å‘è€…åœ¨ä»£ç ä¸­æ¸…æ™°åœ°çœ‹åˆ°å¯¹è±¡çš„æ„å»ºè¿‡ç¨‹ï¼Œä»è€Œæ›´å®¹æ˜“ç†è§£å’Œä¿®æ”¹ä»£ç ã€‚æ­¤å¤–ï¼Œå¯ä»¥ä½¿ç”¨é“¾å¼è°ƒç”¨ï¼Œä»£ç çš„ç»„ç»‡ç»“æ„æ›´åŠ æ¸…æ™°ï¼Œæ˜“äºé˜…è¯»å’Œç¼–å†™ã€‚</li>
<li>å¢å¼ºå¯¹è±¡çš„ä¸å¯å˜æ€§ï¼šå»ºé€ è€…æ¨¡å¼é€šå¸¸ä¸ä¸å¯å˜å¯¹è±¡ï¼ˆImmutable Objectsï¼‰ä¸€èµ·ä½¿ç”¨ã€‚é€šè¿‡ä½¿ç”¨å»ºé€ è€…æ¨¡å¼ï¼Œå¯ä»¥åœ¨å¯¹è±¡åˆ›å»ºè¿‡ç¨‹ä¸­è®¾ç½®æ‰€æœ‰å¿…è¦çš„å±æ€§ï¼Œå¹¶åœ¨å¯¹è±¡æ„å»ºå®Œæˆåå°†å…¶è®¾ç½®ä¸ºä¸å¯å˜ï¼Œä»è€Œç¡®ä¿å¯¹è±¡çš„ä¸€è‡´æ€§å’Œçº¿ç¨‹å®‰å…¨æ€§ï¼Œè¿™æ˜¯ä¸€ç§ä¿æŠ¤æœºåˆ¶ï¼Œä¹Ÿæ˜¯å»ºé€ è€…æ¨¡å¼çš„ç‰¹æ€§ã€‚</li>
<li>å¤„ç†å¯é€‰å‚æ•°ï¼šæŸäº›å¯¹è±¡å¯èƒ½å…·æœ‰è®¸å¤šå¯é€‰å‚æ•°ï¼Œè€Œä¸æ˜¯æ‰€æœ‰å‚æ•°éƒ½éœ€è¦åœ¨æ¯æ¬¡åˆ›å»ºå¯¹è±¡æ—¶æä¾›ã€‚ä½¿ç”¨å»ºé€ è€…æ¨¡å¼ï¼Œå¯ä»¥é€šè¿‡æä¾›ä¸€äº›è®¾ç½®æ–¹æ³•æ¥è®¾ç½®å¯é€‰å‚æ•°ï¼Œè€Œä¸æ˜¯åœ¨æ„é€ å‡½æ•°ä¸­ä½¿ç”¨å¤§é‡çš„å‚æ•°ã€‚è¿™ä½¿å¾—ä»£ç æ›´åŠ ç®€æ´ï¼Œé¿å…äº†é•¿å‚æ•°åˆ—è¡¨çš„é—®é¢˜ã€‚</li>
<li>æ›´å¥½çš„æ‰©å±•æ€§ï¼šå¯ä»¥é€šè¿‡æ‰©å±• <code>Builder</code> ç±»æ¥æ”¯æŒæ–°çš„æ„å»ºæ­¥éª¤ï¼Œæˆ–è€…é€šè¿‡å¼•å…¥ä¸åŒçš„å…·ä½“ <code>Builder</code> ç±»æ¥æ„å»ºä¸åŒçš„å¯¹è±¡å˜ç§ã€‚</li>
</ul>
<h2 id="ç¼ºç‚¹">ç¼ºç‚¹</h2>
<ul>
<li>ä»£ç é‡å¢åŠ ï¼šä½¿ç”¨å»ºé€ è€…æ¨¡å¼é€šå¸¸ä¼šå¼•å…¥é¢å¤–çš„ä»£ç ï¼ŒåŒ…æ‹¬ <code>Builder</code> ç±»æœ¬èº«ä»¥åŠç›®æ ‡ç±»ä¸­çš„ Setter æ–¹æ³•ã€‚</li>
<li>å¯èƒ½å¯¼è‡´è¿‡å¤šçš„ç±»ï¼šå¦‚æœæ¯ä¸ªç±»éƒ½éœ€è¦ä¸€ä¸ªç‹¬ç«‹çš„å»ºé€ è€…ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç±»çš„æ•°é‡æ¿€å¢ï¼Œå¢åŠ äº†ç±»çš„ç®¡ç†å’Œç»´æŠ¤çš„å¤æ‚æ€§ã€‚</li>
<li>å¯¹è±¡çŠ¶æ€åˆ†æ•£ï¼šåœ¨å»ºé€ è€…æ¨¡å¼ä¸­ï¼Œå¯¹è±¡çš„çŠ¶æ€å¯èƒ½åˆ†æ•£åœ¨æ„é€ å™¨å’Œç›®æ ‡ç±»ä¸­ï¼Œè¿™ä½¿å¾—å¯¹è±¡çš„çŠ¶æ€åˆ†æ•£ï¼Œå¯èƒ½å¯¼è‡´ç»´æŠ¤å’Œä¿®æ”¹ä»£ç æ›´åŠ å›°éš¾ã€‚</li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Android TextView HTML è¶…æ–‡æœ¬è·³è½¬]]></title>
        <id>https://LiarrDev.github.io/post/Handle-Android-Textview-Html-Hypertext-Action/</id>
        <link href="https://LiarrDev.github.io/post/Handle-Android-Textview-Html-Hypertext-Action/">
        </link>
        <updated>2025-06-03T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<p>ä¹‹å‰åœ¨ã€<a href="https://liarrdev.github.io/post/Change-the-Partial-Style-within-Android-TextView/">Android æ”¹å˜ TextView å†…å±€éƒ¨æ ·å¼</a>ã€ä¸­ä»‹ç»è¿‡åˆ©ç”¨ HTML æ ‡ç­¾æ¥è®¾ç½®æ ·å¼ï¼Œä½¿ç”¨æ—¶ä½ å¯èƒ½ä¼šé‡åˆ°è¶…æ–‡æœ¬è·³è½¬çš„éœ€æ±‚ï¼Œå¾ˆå®¹æ˜“ä½ å°±èƒ½æƒ³åˆ°ç»™ HTML å­—ç¬¦ä¸²æ·»åŠ  <code>&lt;a&gt;</code> æ ‡ç­¾ï¼š</p>
<pre><code class="language-kotlin">class MainActivity : AppCompatActivity() {
    // ...
    override fun onCreate(savedInstanceState: Bundle?) {
        // ...
        val content = Html.fromHtml(
            &quot;è¿™æ˜¯ä¸€ä¸ªè¶…é“¾æ¥ï¼š&lt;a href='https://google.com'&gt;Google&lt;/a&gt;&quot;,
            Html.FROM_HTML_MODE_LEGACY
        )
        binding.textView.text = content
    }
}
</code></pre>
<p><code>TextView</code> ç¡®å®å‡ºç°äº†è¶…æ–‡æœ¬çš„æ˜¾ç¤ºæ•ˆæœï¼Œä½†æ˜¯å´ä¸èƒ½å¤Ÿå“åº”ç‚¹å‡»ã€‚</p>
<figure data-type="image" tabindex="1"><img src="https://LiarrDev.github.io/post-images/1745051421676.png" alt="TextView è¶…é“¾æ¥æ•ˆæœ" loading="lazy"></figure>
<p>æˆ‘ä»¬è¿˜éœ€è¦å¯¹å…¶åšè¿›ä¸€æ­¥å¤„ç†ã€‚è¿™é‡ŒåŒæ ·ç”¨åˆ°äº†ã€<a href="https://liarrdev.github.io/post/Change-the-Partial-Style-within-Android-TextView/">Android æ”¹å˜ TextView å†…å±€éƒ¨æ ·å¼</a>ã€ä¸­ä»‹ç»çš„å¦ä¸€ç§æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ <code>SpannableString</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-kotlin">class MainActivity : AppCompatActivity() {
    // ...
    override fun onCreate(savedInstanceState: Bundle?) {
        // ...
        val content = Html.fromHtml(
            &quot;è¿™æ˜¯ä¸€ä¸ªè¶…é“¾æ¥ï¼š&lt;a href='https://google.com'&gt;Google&lt;/a&gt;&quot;,
            Html.FROM_HTML_MODE_LEGACY
        )
        binding.textView.text = content
        handleHtmlClick(binding.textView)
    }
    
    private fun handleHtmlClick(textView: TextView) {
        textView.movementMethod = LinkMovementMethod.getInstance()
        val text = textView.text
        if (text is Spannable) {
            val end = text.length
            val spans = text.getSpans(0, end, URLSpan::class.java)
            val sb = SpannableStringBuilder(text)
            sb.clearSpans()
            for (span in spans) {
                sb.setSpan(
                    URLSpan(span.url),
                    text.getSpanStart(span),
                    text.getSpanEnd(span),
                    Spanned.SPAN_EXCLUSIVE_INCLUSIVE
                )
            }
            textView.text = sb
        }
    }
}
</code></pre>
<p>é€šè¿‡ <code>Spanned.getSpans()</code> æ–¹æ³•æå–åˆ°å¯ç‚¹å‡»çš„ <code>URLSpan</code>ï¼Œå¹¶é‡æ–°æ„é€  <code>URLSpan</code> å†æ·»åŠ åˆ° <code>SpannableString</code> ä¸­å³å¯ã€‚<code>URLSpan</code> æ˜¯ <code>ClickableSpan</code> çš„å®ç°ï¼Œå½“ç‚¹å‡»å…¶ä¸­è®¾ç½®äº† Span çš„æ–‡æœ¬æ—¶ï¼Œ<code>URLSpan</code> å°†å°è¯•é€šè¿‡å¯åŠ¨å¸¦æœ‰ <code>Intent.ACTION_VIEW</code> çš„ <code>Activity</code> æ¥æ‰“å¼€ URLã€‚</p>
<p>ä¸Šé¢ä»£ç çš„æ•ˆæœå°±æ˜¯è·³è½¬åˆ°æµè§ˆå™¨æ‰“å¼€è¶…é“¾æ¥ã€‚</p>
<figure data-type="image" tabindex="2"><img src="https://LiarrDev.github.io/post-images/1745051459860.gif" alt="è¶…é“¾æ¥è·³è½¬" loading="lazy"></figure>
<p>é™¤äº†æˆ‘ä»¬å¸¸è§çš„ç½‘é¡µè¶…é“¾æ¥å¤–ï¼Œè¶…æ–‡æœ¬å…¶å®è¿˜åŒ…å«å…¶ä»–åœºæ™¯çš„åº”ç”¨ï¼Œè€Œä¸Šé¢è¯´åˆ° <code>URLSpan</code> å°è¯•é€šè¿‡å¯åŠ¨å¸¦æœ‰ <code>Intent.ACTION_VIEW</code> çš„ <code>Activity</code> æ¥æ‰“å¼€ URLï¼Œè¿™è®©æˆ‘ä»¬å¾ˆå®¹æ˜“å°±æƒ³èµ·ä¹‹å‰ä»‹ç»è¿‡çš„<a href="https://liarrdev.github.io/post/Android-Calling-Email-App-to-Send-Email/">å‘é€é‚®ä»¶</a>ã€‚å¯ä»¥è¿™ä¹ˆå†™ï¼š</p>
<pre><code class="language-kotlin">class MainActivity : AppCompatActivity() {
    // ...
    override fun onCreate(savedInstanceState: Bundle?) {
        // ...
        val content = Html.fromHtml(
            &quot;å‘é‚®ä»¶ç»™ &lt;a href='mailto:foo@bar.com'&gt;foo@bar.com&lt;/a&gt;&quot;,
            Html.FROM_HTML_MODE_LEGACY
        )
        binding.textView.text = content
        handleHtmlClick(binding.textView)
    }
    
    private fun handleHtmlClick(textView: TextView) {
        textView.movementMethod = LinkMovementMethod.getInstance()
        val text = textView.text
        if (text is Spannable) {
            val end = text.length
            val spans = text.getSpans(0, end, URLSpan::class.java)
            val sb = SpannableStringBuilder(text)
            sb.clearSpans()
            for (span in spans) {
                sb.setSpan(
                    URLSpan(span.url),
                    text.getSpanStart(span),
                    text.getSpanEnd(span),
                    Spanned.SPAN_EXCLUSIVE_INCLUSIVE
                )
            }
            textView.text = sb
        }
    }
}
</code></pre>
<p>å®ƒä¹Ÿä¼šç›´æ¥æ‹‰èµ·æ‰‹æœºçš„é‚®ä»¶åº”ç”¨ï¼š</p>
<figure data-type="image" tabindex="3"><img src="https://LiarrDev.github.io/post-images/1745083125426.gif" alt="è¶…æ–‡æœ¬è·³è½¬å‘é€é‚®ä»¶" loading="lazy"></figure>
<p>å¦‚æœå¸Œæœ›æ¥ç®¡ç‚¹å‡»åçš„é€»è¾‘ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªè¡Œå®ç° <code>ClickableSpan</code>ï¼š</p>
<pre><code class="language-kotlin">class MainActivity : AppCompatActivity() {
    // ...
    override fun onCreate(savedInstanceState: Bundle?) {
        // ...
        val content = Html.fromHtml(
            &quot;è¿™æ˜¯ä¸€ä¸ªè¶…é“¾æ¥ï¼š&lt;a href='https://google.com'&gt;Google&lt;/a&gt;&quot;,
            Html.FROM_HTML_MODE_LEGACY
        )
        binding.textView.text = content
        handleHtmlClick(binding.textView)
    }
    
    private fun handleHtmlClick(textView: TextView) {
        textView.movementMethod = LinkMovementMethod.getInstance()
        val text = textView.text
        if (text is Spannable) {
            val end = text.length
            val spans = text.getSpans(0, end, URLSpan::class.java)
            val sb = SpannableStringBuilder(text)
            sb.clearSpans()
            for (span in spans) {
                sb.setSpan(
                    HypertextSpan(this, span.url),
                    text.getSpanStart(span),
                    text.getSpanEnd(span),
                    Spanned.SPAN_EXCLUSIVE_INCLUSIVE
                )
            }
            textView.text = sb
        }
    }
}

class HypertextSpan(private val context: Context, private val url: String) : ClickableSpan() {
    override fun onClick(widget: View) {
        // å¤„ç†ç‚¹å‡»é€»è¾‘
    }
}
</code></pre>
<p>æˆ‘ä»¬æ„é€ ä¸€ä¸ª <code>HypertextSpan</code> æ¥æ¥ç®¡ç‚¹å‡»é€»è¾‘ï¼Œåªéœ€å°†ä¸Šä¸€æ­¥çš„ <code>URLSpan</code> æ›¿æ¢å³å¯ï¼Œæ„é€ æ–¹æ³•ä¸­ä¼ å…¥ <code>Context</code> å’Œ URL å¯ä»¥æ–¹ä¾¿æˆ‘ä»¬å¤„ç†åˆ¤æ–­åŠè·³è½¬ã€‚</p>
<p>æ¯”å¦‚åœ¨åº”ç”¨å†…æ‰“å¼€ç½‘é¡µï¼š</p>
<figure data-type="image" tabindex="4"><img src="https://LiarrDev.github.io/post-images/1745051484830.gif" alt="åº”ç”¨å†…æ¥ç®¡è¶…é“¾æ¥å¤„ç†" loading="lazy"></figure>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Android è°ƒç”¨é‚®ç®±å®¢æˆ·ç«¯å‘é€é‚®ä»¶]]></title>
        <id>https://LiarrDev.github.io/post/Android-Calling-Email-App-to-Send-Email/</id>
        <link href="https://LiarrDev.github.io/post/Android-Calling-Email-App-to-Send-Email/">
        </link>
        <updated>2025-04-23T16:00:00.000Z</updated>
        <content type="html"><![CDATA[<p>åšå•†ä¸šé¡¹ç›®çš„æ—¶å€™ï¼Œåº”ç”¨å¾€å¾€éœ€è¦æä¾›ä¸€äº›ç”¨æˆ·çš„åé¦ˆæ¸ é“ï¼Œå°½ç®¡ç°åœ¨æœ‰å¾®ä¿¡å…¬ä¼—å·ã€å¾®åšç­‰ç­‰æ–¹ä¾¿å¿«æ·çš„é€”å¾„å¯ä»¥ä¸åº”ç”¨å¼€å‘è€…å–å¾—è”ç³»ï¼Œä½†é‚®ç®±ä¹Ÿæ˜¯ä¸å¯æˆ–ç¼ºçš„ä¸€ç§åé¦ˆé€”å¾„ã€‚</p>
<p>åœ¨åº”ç”¨å¼€å‘ä¸­ï¼Œæˆ‘ä»¬æ—¶å¸¸ä¼šæ‹‰èµ·é‚®ç®±åº”ç”¨æ¥å®Œæˆå‘é€é‚®ä»¶çš„æ“ä½œï¼ŒåŒæ—¶è¿˜ä¼šè‡ªåŠ¨å¸®ç”¨æˆ·å¡«å†™éƒ¨åˆ†ä¿¡æ¯ï¼Œå‡å°‘ç”¨æˆ·çš„æ“ä½œæ­¥éª¤ï¼Œä»Šå¤©å°±æ•™å¤§å®¶åœ¨ Android å¼€å‘ä¸­å¦‚ä½•å®ç°è¿™ä¸€æ“ä½œã€‚</p>
<p>å‰ææ˜¯æ‰‹æœºéœ€è¦å®‰è£…å¹¶ç™»å½•é‚®ç®±å®¢æˆ·ç«¯ï¼Œä½ å¯ä»¥ä½¿ç”¨ä¸€äº›é‚®ç®±æœåŠ¡å•†æä¾›çš„å®˜æ–¹åº”ç”¨ï¼Œæ¯”å¦‚ã€Gmailã€ã€ã€QQMailã€ç­‰ç­‰ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨æ‰‹æœºå†…ç½®çš„é‚®ç®±åº”ç”¨ï¼Œå…·ä½“é…ç½®æ“ä½œå¯å‚è€ƒã€<a href="https://liarrdev.github.io/post/Mastering-Smartphone-Built-in-Email-App/">ç”¨å¥½æ‰‹æœºç³»ç»Ÿè‡ªå¸¦çš„é‚®ä»¶å®¢æˆ·ç«¯</a>ã€ã€‚</p>
<p>æœ€ç®€å•çš„åœºæ™¯ï¼Œæˆ‘ä»¬åªéœ€è¦ç»™æŒ‡å®šçš„å®˜æ–¹é‚®ç®±å‘é€ä¸€äº›æ–‡æœ¬å†…å®¹ï¼Œå¯ä»¥è¿™ä¹ˆå†™ï¼š</p>
<pre><code class="language-Kotlin">object EmailSender {
    fun mailToOne(context: Context) {
        val intent = Intent(Intent.ACTION_SENDTO, Uri.parse(&quot;mailto:foo@bar.com&quot;))
        intent.putExtra(Intent.EXTRA_SUBJECT, &quot;è¿™æ˜¯ä¸»é¢˜&quot;)
        intent.putExtra(Intent.EXTRA_TEXT, &quot;è¿™æ˜¯å†…å®¹&quot;)
        context.startActivity(intent);
    }
}
</code></pre>
<p>è¿™é‡Œç”¨åˆ°äº† <code>Activity</code> çš„éšå¼å¯åŠ¨ï¼Œé¦–å…ˆéœ€è¦æŠŠ <code>Intent</code> çš„ <code>action</code> è®¾ç½®ä¸º <code>Intent.ACTION_SENDTO</code>ï¼Œå†å°† <code>data</code> è®¾ç½®ä¸º <code>mailto:</code> å¼€å¤´çš„ <code>Uri</code>ï¼Œå¹¶åœ¨åé¢æ‹¼æ¥é‚®ç®±åœ°å€ï¼Œè¿™æ ·å°±åªæœ‰é‚®ç®±åº”ç”¨æ‰èƒ½å¤Ÿå“åº”æˆ‘ä»¬çš„ <code>Intent</code>ã€‚å¦‚æœéœ€è¦è®¾ç½®ä¸»é¢˜å’Œå†…å®¹ï¼Œå¯ä»¥å¡«å…… <code>Intent.EXTRA_SUBJECT</code> å’Œ <code>Intent.EXTRA_TEXT</code> è¿™ä¸¤ä¸ªå­—æ®µã€‚</p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<figure data-type="image" tabindex="1"><img src="https://LiarrDev.github.io/post-images/1745255773750.gif" alt="å‘é€ç»™å•ä¸€æ”¶ä»¶äºº" loading="lazy"></figure>
<p>é‚®ä»¶ä¸ä»…æ”¯æŒå‘é€ç»™å•ä¸€æ”¶ä»¶äººï¼Œæˆ‘ä»¬å¯ä»¥æŒ‡å®šå¤šä¸ªæ”¶ä»¶äººï¼Œè¿˜æ”¯æŒæŠ„é€ã€å¯†é€ã€‚</p>
<pre><code class="language-Kotlin">object EmailSender {
    fun mailToMultiple(context: Context) {
        val intent = Intent(Intent.ACTION_SENDTO)
        intent.setData(Uri.parse(&quot;mailto:&quot;))
        intent.putExtra(Intent.EXTRA_EMAIL, arrayOf(&quot;foo@bar.com&quot;, &quot;bar@foo.com&quot;))
        intent.putExtra(Intent.EXTRA_CC, arrayOf(&quot;cc@bar.com&quot;))     // æŠ„é€
        intent.putExtra(Intent.EXTRA_BCC, arrayOf(&quot;bcc@bar.com&quot;))   // å¯†é€
        intent.putExtra(Intent.EXTRA_SUBJECT, &quot;è¿™æ˜¯ä¸»é¢˜&quot;)
        intent.putExtra(Intent.EXTRA_TEXT, &quot;è¿™æ˜¯å†…å®¹&quot;)
        context.startActivity(intent)
    }
}
</code></pre>
<p><code>action</code> çš„é…ç½®ä¸ä¸Šæ–‡ä¸€è‡´ï¼Œä½†æ˜¯ <code>data</code> ä¸éœ€è¦æ‹¼æ¥æ”¶ä»¶äººçš„é‚®ç®±åœ°å€ï¼Œè€Œæ˜¯æ”¹æˆåœ¨ <code>Intent.EXTRA_EMAIL</code> å­—æ®µä¼ å…¥ï¼ŒæŠ„é€å’Œå¯†é€çš„é‚®ç®±åœ°å€åˆ™åˆ†åˆ«åœ¨ <code>Intent.EXTRA_CC</code> å’Œ <code>Intent.EXTRA_BCC</code> å­—æ®µä¼ å…¥ï¼Œè¿™ä¸‰ä¸ªå­—æ®µéƒ½æ¥æ”¶å­—ç¬¦ä¸²ç±»å‹çš„æ•°ç»„ï¼Œä¹Ÿå°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥å¡«å……å¤šä¸ªé‚®ç®±åœ°å€ã€‚</p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<figure data-type="image" tabindex="2"><img src="https://LiarrDev.github.io/post-images/1745255801296.gif" alt="å‘é€ç»™å¤šä¸ªæ”¶ä»¶äºº" loading="lazy"></figure>
<p>é‚®ä»¶åŒæ—¶è¿˜èƒ½ä¸Šä¼ é™„ä»¶ï¼Œæˆ‘ä»¬å¯ä»¥è¿™ä¹ˆå†™ï¼š</p>
<pre><code class="language-Kotlin">object EmailSender {
    fun mailAttachments(context: Context) {
        val file = File(PathUtils.getInternalAppFilesPath(), &quot;screenshot.png&quot;)
        val intent = Intent(Intent.ACTION_SEND_MULTIPLE)
        intent.selector = Intent(Intent.ACTION_SENDTO, Uri.parse(&quot;mailto:&quot;))
        intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
        intent.putExtra(Intent.EXTRA_EMAIL, arrayOf(&quot;foo@bar.com&quot;))
        intent.putExtra(Intent.EXTRA_SUBJECT, &quot;è¿™æ˜¯ä¸»é¢˜&quot;)
        intent.putExtra(Intent.EXTRA_STREAM, arrayListOf(UriUtils.file2Uri(file)))
        context.startActivity(intent)
    }
}
</code></pre>
<p>è¿™é‡Œå°† <code>action</code> æ”¹æˆ <code>Intent.ACTION_SEND_MULTIPLE</code>ï¼Œå¦‚æœä»…ä»…æ˜¯è¿™æ ·ä¿®æ”¹ï¼Œé™¤äº†é‚®ç®±åº”ç”¨å¤–ï¼Œè®¸å¤šåº”ç”¨éƒ½èƒ½å¤Ÿå“åº”æˆ‘ä»¬çš„ <code>Intent</code>ï¼Œå› æ­¤è¿˜éœ€è¦è°ƒç”¨ <code>setSelector()</code> æ–¹æ³•ï¼Œä¸ºæ­¤ <code>Intent</code> è®¾ç½®é€‰æ‹©å™¨ã€‚æœ€åå†å‘ <code>Intent.EXTRA_STREAM</code> å­—æ®µä¼ å…¥é™„ä»¶çš„ <code>Uri</code>ï¼Œå®ƒä¹Ÿæ¥æ”¶æ•°ç»„ï¼Œæ„å‘³ç€æˆ‘ä»¬å¯ä»¥ä¼ è¾“å¤šä¸ªé™„ä»¶ã€‚</p>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<figure data-type="image" tabindex="3"><img src="https://LiarrDev.github.io/post-images/1745255822369.gif" alt="å‘é€é™„ä»¶" loading="lazy"></figure>
]]></content>
    </entry>
</feed>